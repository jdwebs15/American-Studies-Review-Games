<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>American History — Block 13 (CS 1–3) Game</title>
<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --ink:#e7eefc; --muted:#a8b4cf;
    --accent:#7aa2ff; --good:#2bd576; --bad:#ff5c7a; --warn:#ffd166;
    --border:rgba(255,255,255,.12); --shadow:0 18px 55px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1000px 650px at 18% 12%, rgba(122,162,255,.18), transparent 60%), var(--bg);
    color:var(--ink); min-height:100vh;
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{width:min(980px,100%); background:rgba(17,26,46,.92); border:1px solid var(--border);
    border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden}
  header{padding:16px 18px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), transparent)}
  .title{display:flex; flex-direction:column; gap:4px}
  .title h1{margin:0; font-size:16px; letter-spacing:.2px}
  .title .sub{color:var(--muted); font-size:12px; line-height:1.3}
  .meta{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
  .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); background:rgba(0,0,0,.18)}
  .pill b{color:var(--ink); font-weight:800}
  main{padding:18px; display:grid; gap:14px}
  .card{background:rgba(0,0,0,.22); border:1px solid var(--border); border-radius:var(--r); padding:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  label{font-size:12px; color:var(--muted)}
  input[type="text"]{
    width:min(420px,100%); padding:10px 12px; border-radius:12px;
    border:1px solid var(--border); background:rgba(0,0,0,.25); color:var(--ink);
    outline:none;
  }
  button{
    cursor:pointer; border:none; border-radius:14px; padding:12px 12px;
    font-weight:900; color:var(--ink); background:rgba(122,162,255,.18);
    border:1px solid rgba(122,162,255,.35);
    transition:transform .08s ease, filter .12s ease;
  }
  button:hover{filter:brightness(1.06)}
  button:active{transform:scale(.99)}
  button.secondary{background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--muted)}
  button.good{background:rgba(43,213,118,.14); border:1px solid rgba(43,213,118,.35)}
  button.bad{background:rgba(255,92,122,.14); border:1px solid rgba(255,92,122,.35)}
  .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
  .kicker{color:var(--muted); font-size:12px}
  .qTitle{margin:0; font-size:14px; line-height:1.35}
  .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .bar{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--border); width:220px}
  .bar>div{height:100%; width:0%; background:rgba(43,213,118,.75)}
  .grid{
    display:grid; gap:10px; margin-top:10px;
    grid-template-columns:repeat(2, minmax(0,1fr));
  }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .hint{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    background:rgba(255,209,102,.10); border:1px solid rgba(255,209,102,.35);
    display:none;
  }
  .hint .small{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}
  .toast{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:rgba(0,0,0,.25); border:1px solid var(--border); padding:12px; border-radius:14px;
    color:var(--ink); font-size:12px; line-height:1.35; margin:10px 0 0;
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="American History Block 13 Game">
  <header>
    <div class="title">
      <h1>American History — Block 13 Game (CS 1–3)</h1>
      <div class="sub">Historical Thinking & Skills • Perfect run required • Hints only after a miss • Auto-advance on correct • Choices shuffled</div>
    </div>
    <div class="meta">
      <div class="pill">Name: <b id="mName">—</b></div>
      <div class="pill">Started: <b id="mStart">—</b></div>
      <div class="pill">Time: <b id="mTime">00:00</b></div>
      <div class="pill">Accuracy: <b id="mAcc">100%</b></div>
    </div>
  </header>

  <main>
    <section id="screenStart" class="card">
      <div class="row">
        <div>
          <div class="kicker">Enter your name to begin</div>
          <div style="margin-top:8px">
            <label for="name">Student Name</label><br/>
            <input id="name" type="text" autocomplete="name" placeholder="Type your name…" />
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="btnStart">Start</button>
          <button id="btnDemo" class="secondary">Demo</button>
        </div>
      </div>
      <div class="toast" style="margin-top:10px">No scrolling needed—2×2 choices stay on-screen.</div>
    </section>

    <section id="screenGame" class="card hidden">
      <div class="qTop">
        <div>
          <div class="kicker" id="qKicker">Question</div>
          <p class="qTitle" id="qText">—</p>
        </div>
        <div class="status">
          <div class="bar"><div id="barFill"></div></div>
          <div class="toast"><span id="qCount">0</span>/<span id="qTotal">0</span></div>
        </div>
      </div>

      <div class="grid" id="choices"></div>

      <div class="hint" id="hintBox" role="note" aria-label="Hint">
        <div><b>Hint (only after a miss):</b></div>
        <div id="hintText" style="margin-top:6px"></div>
        <div class="small" id="hintSmall"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="toast" id="feedback">—</div>
        <div style="display:flex; gap:10px">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </div>
    </section>

    <section id="screenDone" class="card hidden">
      <div class="row">
        <div>
          <h2 id="doneTitle" style="margin:0 0 6px; font-size:16px;">Complete ✅</h2>
          <div class="toast" id="doneMsg">Perfect run achieved. Copy your submit ticket.</div>
        </div>
        <div style="display:flex; gap:10px">
          <button id="btnCopy" class="good">Copy Ticket</button>
          <button id="btnPlayAgain" class="secondary">Play Again</button>
        </div>
      </div>
      <pre id="logOut"></pre>
    </section>
  </main>
</div>

<script>
/* =========
   QUESTIONS — Block 13 (CS 1–3) — 25+ items, standards-anchored
   ========= */

const QUESTIONS = shuffle([
  // ----- CS1: Credibility of sources (primary/secondary) -----
  {
    cs:"CS1",
    prompt:"A diary entry from 1912 describes a factory as “the best place on earth.” What is the MOST important credibility check first?",
    choices:["Author’s perspective and possible motive","How long the diary is","Whether it is typed or handwritten","Whether the diary uses formal language"],
    answer:"Author’s perspective and possible motive",
    hint:{why:"Start by asking who wrote it, what they wanted, and what viewpoint they had.", keyPoints:["Perspective","Motive","Context"] }
  },
  {
    cs:"CS1",
    prompt:"Two sources disagree about an event. Which step best helps evaluate credibility?",
    choices:["Compare both to other credible sources","Assume the longer source is correct","Pick the source that supports your opinion","Ignore both sources"],
    answer:"Compare both to other credible sources",
    hint:{why:"Agreement (or conflict) with other credible evidence is a key check.", keyPoints:["Corroboration","Multiple sources"] }
  },
  {
    cs:"CS1",
    prompt:"A website article about WWII includes no author name or credentials. Which credibility concern is MOST direct?",
    choices:["Qualifications and reputation of the author","Sequence of events","Long-term causation","Correlation vs causation"],
    answer:"Qualifications and reputation of the author",
    hint:{why:"If you can’t identify the author and credentials, credibility is harder to verify.", keyPoints:["Author credentials","Reputation"] }
  },
  {
    cs:"CS1",
    prompt:"A source uses stereotypes to describe a group. Which credibility issue is this?",
    choices:["Bias of the author","Agreement with other sources","Accuracy and consistency","Circumstances of publication"],
    answer:"Bias of the author",
    hint:{why:"Stereotypes are a strong sign of bias and can distort interpretation.", keyPoints:["Bias","Stereotypes"] }
  },
  {
    cs:"CS1",
    prompt:"A politician’s speech argues a policy was “universally supported,” but later claims it was “controversial.” What credibility check is best?",
    choices:["Accuracy and consistency of arguments","Author’s handwriting","Length of the speech","Whether it is a primary source"],
    answer:"Accuracy and consistency of arguments",
    hint:{why:"Internal consistency matters—contradictions weaken credibility.", keyPoints:["Consistency","Contradictions"] }
  },
  {
    cs:"CS1",
    prompt:"A newspaper editorial from 1890 praises a company owned by the editor’s brother. Which credibility check applies MOST?",
    choices:["Circumstances in which the author prepared the source","Agreement with other credible sources","Whether it is primary vs secondary","Correlation"],
    answer:"Circumstances in which the author prepared the source",
    hint:{why:"Conflicts of interest and context of creation affect credibility.", keyPoints:["Conflict of interest","Context"] }
  },
  {
    cs:"CS1",
    prompt:"Which statement BEST distinguishes a primary source from a secondary source?",
    choices:["Primary is created at the time; secondary interprets later","Primary is always unbiased; secondary is always biased","Primary is always longer; secondary is shorter","Primary is online; secondary is in books"],
    answer:"Primary is created at the time; secondary interprets later",
    hint:{why:"Primary = direct evidence from the time; secondary = later analysis/interpretation.", keyPoints:["Primary vs secondary","Time of creation"] }
  },
  {
    cs:"CS1",
    prompt:"A textbook cites multiple historians and includes footnotes. Which credibility factor is MOST supported by this?",
    choices:["Agreement with other credible sources","Stereotyping language","Author is an eyewitness","It must be primary evidence"],
    answer:"Agreement with other credible sources",
    hint:{why:"Citations and multiple references show corroboration and traceability.", keyPoints:["Citations","Corroboration"] }
  },
  {
    cs:"CS1",
    prompt:"A photo is used to prove a protest was violent, but the caption is missing. What is the BEST credibility step?",
    choices:["Investigate the photo’s origin and context","Assume the photo proves violence","Reject all photos as evidence","Only trust modern sources"],
    answer:"Investigate the photo’s origin and context",
    hint:{why:"You need who/when/where/why and whether it was staged or cropped.", keyPoints:["Origin","Context","Purpose"] }
  },

  // ----- CS2: Thesis + evidence (support/refute, multiple source types) -----
  {
    cs:"CS2",
    prompt:"Which thesis is strongest (arguable + specific)?",
    choices:[
      "Industrialization happened in America.",
      "Industrialization changed everything.",
      "Industrialization increased factory output but also intensified urban crowding and labor conflict.",
      "History is important."
    ],
    answer:"Industrialization increased factory output but also intensified urban crowding and labor conflict.",
    hint:{why:"A strong thesis is specific and makes a claim you can prove with evidence.", keyPoints:["Specific claim","Arguable","Evidence-ready"] }
  },
  {
    cs:"CS2",
    prompt:"A student says: “The New Deal ended the Great Depression.” What is the BEST historian move?",
    choices:["Test the claim using evidence from multiple sources","Accept it because it’s common knowledge","Replace it with a list of events","Ignore counterevidence"],
    answer:"Test the claim using evidence from multiple sources",
    hint:{why:"Historians support/refute assertions using evidence and comparison.", keyPoints:["Support/refute","Multiple sources"] }
  },
  {
    cs:"CS2",
    prompt:"Which item is MOST clearly an example of evidence historians can use?",
    choices:["An artifact from the period","A guess about what people felt","A modern meme","A rumor with no source"],
    answer:"An artifact from the period",
    hint:{why:"Artifacts are a recognized evidence type used to build explanations.", keyPoints:["Artifacts","Primary evidence"] }
  },
  {
    cs:"CS2",
    prompt:"A thesis claims: “Women’s roles expanded during WWII.” Which evidence BEST supports it?",
    choices:["Employment records showing increased women workers","A modern opinion post","A random unsourced quote","A timeline with no documents"],
    answer:"Employment records showing increased women workers",
    hint:{why:"Records/data from the time directly support the claim.", keyPoints:["Direct evidence","Relevance"] }
  },
  {
    cs:"CS2",
    prompt:"Which action best shows a historian refining an explanation?",
    choices:["Comparing conflicting eyewitness accounts and revising the claim","Keeping the same claim even if evidence disagrees","Using only one source to avoid confusion","Choosing evidence that matches feelings"],
    answer:"Comparing conflicting eyewitness accounts and revising the claim",
    hint:{why:"Historians revise interpretations when evidence requires it.", keyPoints:["Compare sources","Refine explanation"] }
  },
  {
    cs:"CS2",
    prompt:"A student writes a paragraph listing events but makes no claim. What is missing?",
    choices:["A thesis that interprets significance","More adjectives","A longer timeline","A conclusion with feelings"],
    answer:"A thesis that interprets significance",
    hint:{why:"A thesis gives meaning and interpretation beyond a list.", keyPoints:["Interpretation","Significance"] }
  },
  {
    cs:"CS2",
    prompt:"Which is the BEST reason historians cite sources?",
    choices:["So others can verify and trace evidence","To make writing look longer","To avoid thinking critically","To guarantee agreement"],
    answer:"So others can verify and trace evidence",
    hint:{why:"Citations let readers check evidence and strengthen credibility.", keyPoints:["Verification","Traceability"] }
  },
  {
    cs:"CS2",
    prompt:"A claim says: “The Great Migration changed northern culture.” Which evidence type BEST fits?",
    choices:["Music/literature examples from the period","A single modern tweet","An unrelated map of Europe","A blank chart"],
    answer:"Music/literature examples from the period",
    hint:{why:"Cultural change is supported by period art, writing, music, and related records.", keyPoints:["Relevant evidence","Culture"] }
  },

  // ----- CS3: Cause/effect/sequence/correlation; multiple causation; long/short-term -----
  {
    cs:"CS3",
    prompt:"Which best describes the difference between cause and effect?",
    choices:["Cause leads to an outcome; effect is the outcome","Effect always happens first; cause happens later","Cause is opinion; effect is fact","They mean the same thing"],
    answer:"Cause leads to an outcome; effect is the outcome",
    hint:{why:"Cause = why it happened; effect = what resulted.", keyPoints:["Cause → effect","Outcome"] }
  },
  {
    cs:"CS3",
    prompt:"A timeline shows Event A happened before Event B. What can you conclude for sure?",
    choices:["Sequence, not necessarily causation","B caused A","A and B are unrelated","Correlation proves cause"],
    answer:"Sequence, not necessarily causation",
    hint:{why:"Order matters, but you still need evidence to prove cause.", keyPoints:["Sequence","Causation requires evidence"] }
  },
  {
    cs:"CS3",
    prompt:"City population rises at the same time factory jobs increase. This is BEST described as:",
    choices:["Correlation that may suggest a relationship","Proof that factories caused all city growth","Proof that cities caused factories","A random coincidence with no possible link"],
    answer:"Correlation that may suggest a relationship",
    hint:{why:"Correlation = move together; it can suggest but doesn’t prove cause.", keyPoints:["Correlation ≠ causation","Investigate evidence"] }
  },
  {
    cs:"CS3",
    prompt:"Which example shows multiple causation?",
    choices:["The Great Depression resulted from several factors including credit use and speculation","A single storm caused a harvest to fail","A person moved for one reason only","One law caused every change"],
    answer:"The Great Depression resulted from several factors including credit use and speculation",
    hint:{why:"Multiple causation means more than one factor contributes to an event.", keyPoints:["Multiple factors","Complex causes"] }
  },
  {
    cs:"CS3",
    prompt:"Which is a long-term cause of a migration movement?",
    choices:["Years of discriminatory laws and limited opportunities","A one-day snowstorm","A single newspaper headline","A short strike"],
    answer:"Years of discriminatory laws and limited opportunities",
    hint:{why:"Long-term causes build over time and set conditions.", keyPoints:["Long-term conditions","Structural factors"] }
  },
  {
    cs:"CS3",
    prompt:"Which is a short-term cause that could trigger migration?",
    choices:["Immediate job openings in a new region","Centuries of cultural traditions","Long-standing climate patterns","A decades-long political ideology"],
    answer:"Immediate job openings in a new region",
    hint:{why:"Short-term causes are immediate triggers (like jobs, crises, events).", keyPoints:["Immediate trigger","Short-term factor"] }
  },
  {
    cs:"CS3",
    prompt:"A historian studies how one event led to another. This is MOST directly analysis of:",
    choices:["Sequence and connection between events","Author reputation","Primary vs secondary","Bias only"],
    answer:"Sequence and connection between events",
    hint:{why:"Sequence asks how events connect across time.", keyPoints:["Sequence","Linkage"] }
  },
  {
    cs:"CS3",
    prompt:"Which statement best shows cause-and-effect reasoning?",
    choices:[
      "Because factories offered jobs, more people moved to cities, increasing crowding.",
      "Cities are crowded and factories exist.",
      "Factories are interesting.",
      "Crowding happened at some point."
    ],
    answer:"Because factories offered jobs, more people moved to cities, increasing crowding.",
    hint:{why:"It clearly states why (cause) and what happened (effect).", keyPoints:["Because…","Led to…"] }
  },
  {
    cs:"CS3",
    prompt:"Two events occur together: increased car ownership and new highways. A historian should FIRST:",
    choices:["Check evidence to see whether one influenced the other","Assume highways caused cars","Assume cars caused highways","Ignore the connection"],
    answer:"Check evidence to see whether one influenced the other",
    hint:{why:"You test relationships with evidence, not assumption.", keyPoints:["Test with evidence","Avoid assumption"] }
  },
  {
    cs:"CS3",
    prompt:"Which scenario BEST reflects both long- and short-term causes?",
    choices:[
      "Long-term discrimination + short-term job demand both encourage a move",
      "Only one law explains everything",
      "Only the weather matters",
      "Order doesn’t matter in history"
    ],
    answer:"Long-term discrimination + short-term job demand both encourage a move",
    hint:{why:"Many events have conditions (long-term) and triggers (short-term).", keyPoints:["Long-term + short-term","Multiple causation"] }
  },
  {
    cs:"CS3",
    prompt:"A historian argues: “Event X caused Event Y,” but provides only that X happened before Y. What is missing?",
    choices:["Evidence linking the events beyond sequence","A longer timeline","A secondary source only","A stereotype about people involved"],
    answer:"Evidence linking the events beyond sequence",
    hint:{why:"Sequence alone doesn’t prove causation.", keyPoints:["Need linkage evidence","Mechanism"] }
  },
  {
    cs:"CS3",
    prompt:"Which statement best distinguishes correlation from causation?",
    choices:[
      "Correlation is a relationship; causation is proof one event produced another.",
      "Correlation means proven cause.",
      "Causation means events happened together.",
      "They are identical."
    ],
    answer:"Correlation is a relationship; causation is proof one event produced another.",
    hint:{why:"Correlation suggests a connection; causation confirms cause with evidence.", keyPoints:["Suggest vs prove","Evidence required"] }
  },
  {
    cs:"CS3",
    prompt:"A historian compares causes across decades and identifies patterns. This is MOST closely analysis of:",
    choices:["Long- and short-term causal relationships","Author handwriting","Primary vs secondary only","Opinion polling"],
    answer:"Long- and short-term causal relationships",
    hint:{why:"That’s exactly long/short-term causation analysis.", keyPoints:["Long-term","Short-term","Patterns"] }
  }
]);

/* =========
   ENGINE
   ========= */
const $ = (s)=>document.querySelector(s);
const screens = { start: $("#screenStart"), game: $("#screenGame"), done: $("#screenDone") };
const meta = { name: $("#mName"), start: $("#mStart"), time: $("#mTime"), acc: $("#mAcc") };
const qUI = {
  kicker: $("#qKicker"), text: $("#qText"), choices: $("#choices"),
  count: $("#qCount"), total: $("#qTotal"), bar: $("#barFill"),
  feedback: $("#feedback"),
  hintBox: $("#hintBox"), hintText: $("#hintText"), hintSmall: $("#hintSmall")
};

let state = {
  startedAt:null, timerId:null,
  idx:0, misses:0, attempts:0,
  qOrder:[]
};

$("#btnDemo").addEventListener("click", ()=>{ $("#name").value="Demo Student"; $("#name").focus(); });
$("#btnStart").addEventListener("click", startGame);
$("#btnReset").addEventListener("click", resetAll);
$("#btnPlayAgain").addEventListener("click", resetAll);
$("#btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("#logOut").innerText);
    $("#btnCopy").textContent="Copied ✅";
    setTimeout(()=>$("#btnCopy").textContent="Copy Ticket", 1100);
  }catch(e){
    alert("Copy failed. You can manually select and copy the ticket text.");
  }
});

function calcAccuracy(){
  if(state.attempts <= 0) return 100;
  return Math.round(((state.attempts - state.misses) / state.attempts) * 100);
}
function updateAccuracy(){
  meta.acc.textContent = `${calcAccuracy()}%`;
}

/* IMPORTANT: shuffle choices per question render (prevents correct always being first) */
function shuffledChoices(q){
  const arr = [...q.choices];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function startGame(){
  const n = ($("#name").value||"").trim();
  if(!n){ alert("Please enter your name."); return; }

  state.startedAt = new Date();
  meta.name.textContent = n;
  meta.start.textContent = stamp(state.startedAt);
  meta.time.textContent = "00:00";

  state.qOrder = shuffle([...QUESTIONS]);
  state.idx = 0;
  state.misses = 0;
  state.attempts = 0;

  $("#qTotal").textContent = String(state.qOrder.length);
  updateAccuracy();

  switchTo("game");
  startTimer();
  renderQuestion();
}

function renderQuestion(){
  const q = state.qOrder[state.idx];
  if(!q) return finish();

  qUI.kicker.textContent = `${q.cs} • Question ${state.idx+1}`;
  qUI.text.textContent = q.prompt;

  qUI.count.textContent = String(state.idx+1);
  qUI.total.textContent = String(state.qOrder.length);
  qUI.bar.style.width = `${Math.round((state.idx/state.qOrder.length)*100)}%`;

  qUI.feedback.textContent = "Choose the best answer.";
  qUI.feedback.style.color = "var(--muted)";

  qUI.hintBox.style.display = "none";
  qUI.hintText.textContent = "";
  qUI.hintSmall.textContent = "";

  qUI.choices.innerHTML = "";
  shuffledChoices(q).forEach(choice=>{
    const btn = document.createElement("button");
    btn.textContent = choice;
    btn.addEventListener("click", ()=>submit(choice));
    qUI.choices.appendChild(btn);
  });
}

function submit(choice){
  const q = state.qOrder[state.idx];

  state.attempts++;
  updateAccuracy();

  if(choice === q.answer){
    qUI.feedback.textContent = "Correct ✅";
    qUI.feedback.style.color = "var(--good)";
    flashButtons(choice, true);
    setTimeout(()=>{
      state.idx++;
      renderQuestion();
    }, 320);
    return;
  }

  state.misses++;
  updateAccuracy();

  qUI.feedback.textContent = "Not yet ❌ Try again.";
  qUI.feedback.style.color = "var(--bad)";
  flashButtons(choice, false);

  qUI.hintBox.style.display = "block";
  qUI.hintText.textContent = q.hint?.why || "Think back to the historical thinking skill being tested.";
  qUI.hintSmall.textContent = q.hint?.keyPoints?.length
    ? ("Key points: " + q.hint.keyPoints.join(" • "))
    : "";
}

function finish(){
  stopTimer();
  qUI.bar.style.width = "100%";

  const endedAt = new Date();
  const durationSec = Math.floor((endedAt - state.startedAt)/1000);
  const accuracy = calcAccuracy();

  if(state.misses > 0){
    $("#doneTitle").textContent = "Not Passed ❌";
    $("#doneMsg").textContent = "You finished, but this attempt had misses. Retake for a perfect run to earn the submit ticket.";
    $("#btnCopy").style.display = "none";

    $("#logOut").textContent =
`NOT PASSED — Retake Required

Student: ${meta.name.textContent}
Started: ${stamp(state.startedAt)}
Ended:   ${stamp(endedAt)}
Duration (sec): ${durationSec}
Accuracy: ${accuracy}%
Misses: ${state.misses}

RULE: To earn a submit ticket, you must complete the game with 0 misses (100% accuracy).`;
    switchTo("done");
    return;
  }

  $("#doneTitle").textContent = "Complete ✅";
  $("#doneMsg").textContent = "Perfect run achieved (0 misses). Copy your submit ticket.";
  $("#btnCopy").style.display = "inline-flex";

  const ticket = {
    status: "PASSED",
    game: "American History — Block 13 (CS 1–3)",
    student: meta.name.textContent,
    started: stamp(state.startedAt),
    ended: stamp(endedAt),
    duration_seconds: durationSec,
    total_questions: state.qOrder.length,
    total_attempts: state.attempts,
    misses: state.misses,
    accuracy_percent: 100
  };

  $("#logOut").textContent = JSON.stringify(ticket, null, 2);
  switchTo("done");
}

function switchTo(which){
  Object.values(screens).forEach(el=>el.classList.add("hidden"));
  screens[which].classList.remove("hidden");
}

function startTimer(){
  stopTimer();
  state.timerId = setInterval(()=>{
    const s = Math.floor((new Date() - state.startedAt)/1000);
    meta.time.textContent = fmtTime(s);
  }, 250);
}
function stopTimer(){
  if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
}

function resetAll(){
  stopTimer();
  meta.name.textContent="—";
  meta.start.textContent="—";
  meta.time.textContent="00:00";
  meta.acc.textContent="100%";
  $("#name").value="";
  $("#btnCopy").textContent="Copy Ticket";
  $("#btnCopy").style.display = "inline-flex";
  switchTo("start");
}

function fmtTime(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stamp(d){
  return d.toLocaleString(undefined, {
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function flashButtons(choice, correct){
  [...qUI.choices.querySelectorAll("button")].forEach(b=>{
    if(b.textContent === choice){
      b.classList.add(correct ? "good" : "bad");
      setTimeout(()=>b.classList.remove("good","bad"), 320);
    }
  });
}
</script>
</body>
</html>
