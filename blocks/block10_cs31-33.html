<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>American History — Block 10 (CS 31–33) Game</title>
<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --ink:#e7eefc; --muted:#a8b4cf;
    --accent:#7aa2ff; --good:#2bd576; --bad:#ff5c7a; --warn:#ffd166;
    --border:rgba(255,255,255,.12); --shadow:0 18px 55px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1000px 650px at 18% 12%, rgba(122,162,255,.18), transparent 60%), var(--bg);
    color:var(--ink); min-height:100vh;
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{width:min(980px,100%); background:rgba(17,26,46,.9); border:1px solid var(--border);
    border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden}
  header{padding:16px 18px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), transparent)}
  .title{display:flex; flex-direction:column; gap:4px}
  .title h1{margin:0; font-size:16px; letter-spacing:.2px}
  .title .sub{color:var(--muted); font-size:12px; line-height:1.3}
  .meta{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
  .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); background:rgba(0,0,0,.18)}
  .pill b{color:var(--ink); font-weight:700}
  main{padding:18px; display:grid; gap:14px}
  .card{background:rgba(0,0,0,.22); border:1px solid var(--border); border-radius:var(--r); padding:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  label{font-size:12px; color:var(--muted)}
  input[type="text"]{
    width:min(420px,100%); padding:10px 12px; border-radius:12px;
    border:1px solid var(--border); background:rgba(0,0,0,.25); color:var(--ink);
    outline:none;
  }
  button{
    cursor:pointer; border:none; border-radius:14px; padding:12px 12px;
    font-weight:800; color:var(--ink); background:rgba(122,162,255,.18);
    border:1px solid rgba(122,162,255,.35);
    transition:transform .08s ease, filter .12s ease;
  }
  button:hover{filter:brightness(1.06)}
  button:active{transform:scale(.99)}
  button.secondary{background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--muted)}
  button.good{background:rgba(43,213,118,.14); border:1px solid rgba(43,213,118,.35)}
  button.bad{background:rgba(255,92,122,.14); border:1px solid rgba(255,92,122,.35)}
  .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
  .kicker{color:var(--muted); font-size:12px}
  .qTitle{margin:0; font-size:14px; line-height:1.35}
  .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .bar{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--border); width:220px}
  .bar>div{height:100%; width:0%; background:rgba(43,213,118,.75)}
  .grid{
    display:grid; gap:10px; margin-top:10px;
    grid-template-columns:repeat(2, minmax(0,1fr));
  }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .hint{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    background:rgba(255,209,102,.10); border:1px solid rgba(255,209,102,.35);
    display:none;
  }
  .hint .small{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}
  .toast{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:rgba(0,0,0,.25); border:1px solid var(--border); padding:12px; border-radius:14px;
    color:var(--ink); font-size:12px; line-height:1.35; margin:10px 0 0;
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="American History Block 10 Game">
  <header>
    <div class="title">
      <h1>American History — Block 10 Game (CS 31–33)</h1>
      <div class="sub">Post–Cold War foreign policy • Globalization & economic change • Social/demographic/tech change • Perfect run required</div>
    </div>
    <div class="meta">
      <div class="pill">Name: <b id="mName">—</b></div>
      <div class="pill">Started: <b id="mStart">—</b></div>
      <div class="pill">Time: <b id="mTime">00:00</b></div>
      <div class="pill">Accuracy: <b id="mAcc">100%</b></div>
    </div>
  </header>

  <main>
    <section id="screenStart" class="card">
      <div class="row">
        <div>
          <div class="kicker">Enter your name to begin</div>
          <div style="margin-top:8px">
            <label for="name">Student Name</label><br/>
            <input id="name" type="text" autocomplete="name" placeholder="Type your name…" />
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="btnStart">Start</button>
          <button id="btnDemo" class="secondary">Demo</button>
        </div>
      </div>
      <div class="toast" style="margin-top:10px">Rules: hints only after a miss • accuracy reflects misses • must finish with 0 misses to earn ticket.</div>
    </section>

    <section id="screenGame" class="card hidden">
      <div class="qTop">
        <div>
          <div class="kicker" id="qKicker">Question</div>
          <p class="qTitle" id="qText">—</p>
        </div>
        <div class="status">
          <div class="bar"><div id="barFill"></div></div>
          <div class="toast"><span id="qCount">0</span>/<span id="qTotal">0</span></div>
        </div>
      </div>

      <div class="grid" id="choices"></div>

      <div class="hint" id="hintBox" role="note" aria-label="Hint">
        <div><b>Hint (only after a miss):</b></div>
        <div id="hintText" style="margin-top:6px"></div>
        <div class="small" id="hintSmall"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="toast" id="feedback">—</div>
        <div style="display:flex; gap:10px">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </div>
    </section>

    <section id="screenDone" class="card hidden">
      <div class="row">
        <div>
          <h2 id="doneTitle" style="margin:0 0 6px; font-size:16px;">Complete ✅</h2>
          <div class="toast" id="doneMsg">Perfect run achieved. Copy your submit ticket.</div>
        </div>
        <div style="display:flex; gap:10px">
          <button id="btnCopy" class="good">Copy Ticket</button>
          <button id="btnPlayAgain" class="secondary">Play Again</button>
        </div>
      </div>
      <pre id="logOut"></pre>
    </section>
  </main>
</div>

<script>
/* =========================================================
   QUESTIONS — Block 10 (CS 31–33) — 30 items (balanced)
   - CS31 (10): U.S. foreign policy since the Cold War
   - CS32 (10): Economic/political changes (globalization, restructuring)
   - CS33 (10): Social/demographic/tech change in contemporary America
   ========================================================= */
const QUESTIONS = shuffle([

  /* -------------------- CS31 (10) -------------------- */
  {
    cs:"CS31",
    prompt:"Which statement best describes a major change in U.S. foreign policy after the Cold War ended?",
    choices:[
      "The U.S. faced new security challenges, including regional conflicts and terrorism",
      "The U.S. ended all alliances and stopped participating in world affairs",
      "Foreign policy focused only on colonial expansion",
      "The U.S. refused to use diplomacy in any form"
    ],
    answer:"The U.S. faced new security challenges, including regional conflicts and terrorism",
    hint:{ why:"After 1991, threats shifted from a single superpower rivalry to diverse challenges.", keyPoints:["New threats","Terrorism","Regional conflicts"] }
  },
  {
    cs:"CS31",
    prompt:"Which event most directly led the United States to launch a large-scale “War on Terror”?",
    choices:[
      "Terrorist attacks on September 11, 2001",
      "The signing of the Treaty of Versailles",
      "The start of the Great Depression",
      "The Louisiana Purchase"
    ],
    answer:"Terrorist attacks on September 11, 2001",
    hint:{ why:"9/11 reshaped U.S. security priorities and foreign policy decisions.", keyPoints:["9/11","Security shift"] }
  },
  {
    cs:"CS31",
    prompt:"Which goal most closely matches U.S. participation in NATO after the Cold War?",
    choices:[
      "Maintain collective security through cooperation among member nations",
      "End international trade between allies",
      "Replace elections with military rule",
      "Prevent all immigration into the U.S."
    ],
    answer:"Maintain collective security through cooperation among member nations",
    hint:{ why:"NATO is a collective defense alliance based on mutual security commitments.", keyPoints:["Alliances","Collective defense"] }
  },
  {
    cs:"CS31",
    prompt:"Cause → effect: The collapse of the Soviet Union most directly contributed to:",
    choices:[
      "A shift in U.S. focus toward new global issues and emerging regional conflicts",
      "An immediate end to all U.S. military spending",
      "A return to isolationism with no global involvement",
      "The abolition of all international organizations"
    ],
    answer:"A shift in U.S. focus toward new global issues and emerging regional conflicts",
    hint:{ why:"With the USSR gone, U.S. policy pivoted toward new types of global challenges.", keyPoints:["Post-1991 shift","Regional conflicts"] }
  },
  {
    cs:"CS31",
    prompt:"Which action best reflects how the U.S. often addresses global crises in the post–Cold War era?",
    choices:[
      "Working with international partners through coalitions or organizations",
      "Avoiding all diplomacy and refusing negotiation",
      "Ending foreign aid entirely",
      "Only using state governments to conduct foreign policy"
    ],
    answer:"Working with international partners through coalitions or organizations",
    hint:{ why:"Coalitions and international cooperation are common in post–Cold War interventions.", keyPoints:["Coalitions","International cooperation"] }
  },
  {
    cs:"CS31",
    prompt:"Which statement best explains why the Middle East has remained important in U.S. foreign policy since the late 20th century?",
    choices:[
      "Its strategic importance includes security concerns, regional stability, and energy resources",
      "It is the only region with elections",
      "It has no connection to U.S. interests",
      "It contains all NATO headquarters"
    ],
    answer:"Its strategic importance includes security concerns, regional stability, and energy resources",
    hint:{ why:"U.S. involvement often relates to security, stability, and economic interests.", keyPoints:["Security","Stability","Resources"] }
  },
  {
    cs:"CS31",
    prompt:"A student says, “After the Cold War, the U.S. no longer used diplomacy.” Which correction is strongest?",
    choices:[
      "The U.S. continued to use diplomacy, alliances, and negotiations alongside military action when needed",
      "Diplomacy ended permanently in 1991",
      "Diplomacy only existed during World War I",
      "Diplomacy is illegal under the Constitution"
    ],
    answer:"The U.S. continued to use diplomacy, alliances, and negotiations alongside military action when needed",
    hint:{ why:"Foreign policy uses a mix of tools: diplomacy, alliances, aid, and sometimes force.", keyPoints:["Multiple tools","Diplomacy continues"] }
  },
  {
    cs:"CS31",
    prompt:"Which scenario best illustrates the challenge of “nation-building” in U.S. foreign policy?",
    choices:[
      "Rebuilding institutions and stability in a country after conflict is difficult and takes time",
      "Winning a war automatically guarantees stable democracy",
      "All countries adopt U.S. laws immediately after intervention",
      "International aid always fails in every case"
    ],
    answer:"Rebuilding institutions and stability in a country after conflict is difficult and takes time",
    hint:{ why:"Nation-building is complex due to politics, security, culture, and economics.", keyPoints:["Complexity","Long-term stability"] }
  },
  {
    cs:"CS31",
    prompt:"Which best describes how terrorism influenced U.S. foreign policy after 2001?",
    choices:[
      "It increased focus on homeland security and international counterterrorism efforts",
      "It ended the use of intelligence agencies",
      "It eliminated all global travel",
      "It caused the U.S. to withdraw from every alliance"
    ],
    answer:"It increased focus on homeland security and international counterterrorism efforts",
    hint:{ why:"Post-2001 policy emphasized preventing attacks and disrupting terror networks.", keyPoints:["Homeland security","Counterterrorism"] }
  },
  {
    cs:"CS31",
    prompt:"Which statement BEST summarizes CS31?",
    choices:[
      "Since the Cold War, U.S. foreign policy has addressed new threats and used alliances, diplomacy, and military power in different combinations",
      "Since the Cold War, the U.S. has avoided global involvement entirely",
      "Since the Cold War, U.S. foreign policy focused only on settling the frontier",
      "Since the Cold War, the U.S. has had no security concerns"
    ],
    answer:"Since the Cold War, U.S. foreign policy has addressed new threats and used alliances, diplomacy, and military power in different combinations",
    hint:{ why:"CS31 focuses on post–Cold War challenges and U.S. responses.", keyPoints:["New threats","Mixed strategies"] }
  },

  /* -------------------- CS32 (10) -------------------- */
  {
    cs:"CS32",
    prompt:"Which statement best explains how globalization affected the U.S. economy?",
    choices:[
      "It increased global trade and competition, impacting jobs and industries",
      "It ended international trade completely",
      "It guaranteed the same wages in all countries",
      "It eliminated the need for education"
    ],
    answer:"It increased global trade and competition, impacting jobs and industries",
    hint:{ why:"Globalization connects markets, creating benefits and challenges for workers and companies.", keyPoints:["Trade","Competition","Job shifts"] }
  },
  {
    cs:"CS32",
    prompt:"Which example best illustrates economic restructuring in the late 20th century?",
    choices:[
      "A decline in some manufacturing jobs and growth in service/technology sectors",
      "A return to an economy based mostly on small farms",
      "The disappearance of all corporations",
      "A nationwide ban on computers"
    ],
    answer:"A decline in some manufacturing jobs and growth in service/technology sectors",
    hint:{ why:"Many regions experienced deindustrialization while other sectors expanded.", keyPoints:["Deindustrialization","Service/tech growth"] }
  },
  {
    cs:"CS32",
    prompt:"Cause → effect: Increased competition from overseas manufacturers most directly led to:",
    choices:[
      "Pressure on U.S. industries to modernize, relocate, or reduce labor costs",
      "An end to consumer choice",
      "A complete stop in world trade",
      "Guaranteed job security for all workers"
    ],
    answer:"Pressure on U.S. industries to modernize, relocate, or reduce labor costs",
    hint:{ why:"Competition can force businesses to change production strategies.", keyPoints:["Competition","Business adaptation"] }
  },
  {
    cs:"CS32",
    prompt:"Which best describes a potential benefit of free trade agreements for consumers?",
    choices:[
      "Lower prices and more product choices",
      "Guaranteed higher prices for all goods",
      "An end to imports",
      "Elimination of competition"
    ],
    answer:"Lower prices and more product choices",
    hint:{ why:"Trade can lower costs and expand availability of goods.", keyPoints:["Lower prices","More variety"] }
  },
  {
    cs:"CS32",
    prompt:"Which concern is most often raised about globalization’s impact on workers?",
    choices:[
      "Job loss or wage pressure in industries facing outsourcing or import competition",
      "Too many factories returning to the U.S.",
      "A complete end to technology jobs",
      "No effect on any worker"
    ],
    answer:"Job loss or wage pressure in industries facing outsourcing or import competition",
    hint:{ why:"Some workers face displacement when production moves or competition increases.", keyPoints:["Outsourcing","Wage pressure"] }
  },
  {
    cs:"CS32",
    prompt:"Which statement best explains why energy prices can influence the U.S. economy?",
    choices:[
      "Higher energy costs can raise transportation and production expenses across industries",
      "Energy costs only matter for farmers in 1800",
      "Energy prices never affect inflation or spending",
      "Energy costs determine Supreme Court decisions"
    ],
    answer:"Higher energy costs can raise transportation and production expenses across industries",
    hint:{ why:"Energy is an input for many goods/services, so prices ripple through the economy.", keyPoints:["Costs","Ripple effects"] }
  },
  {
    cs:"CS32",
    prompt:"Which scenario best illustrates the relationship between technology and productivity?",
    choices:[
      "Automation allows firms to produce more output with fewer inputs",
      "Technology always reduces output",
      "Automation forces everyone to stop working",
      "Technology only affects sports and entertainment"
    ],
    answer:"Automation allows firms to produce more output with fewer inputs",
    hint:{ why:"Technology can improve efficiency, increasing productivity.", keyPoints:["Automation","Efficiency"] }
  },
  {
    cs:"CS32",
    prompt:"A student claims, “Economic change only affects business owners.” Which correction is strongest?",
    choices:[
      "Economic change affects workers, communities, and government policy decisions too",
      "Workers are never affected by economic change",
      "Only presidents are affected by economic change",
      "Economic change ended in 1945"
    ],
    answer:"Economic change affects workers, communities, and government policy decisions too",
    hint:{ why:"Job markets, wages, tax bases, and policy debates shift with economic change.", keyPoints:["Workers","Communities","Policy"] }
  },
  {
    cs:"CS32",
    prompt:"Which best explains how the U.S. economy can be linked to global events?",
    choices:[
      "International crises can disrupt supply chains and affect prices and markets",
      "Global events never affect U.S. prices",
      "The U.S. does not trade with any country",
      "Only state governments respond to global markets"
    ],
    answer:"International crises can disrupt supply chains and affect prices and markets",
    hint:{ why:"Connected markets mean global events can impact U.S. consumers and businesses.", keyPoints:["Interdependence","Supply chains"] }
  },
  {
    cs:"CS32",
    prompt:"Which statement BEST summarizes CS32?",
    choices:[
      "Globalization and restructuring changed the U.S. economy, creating new opportunities and new challenges",
      "The U.S. economy stayed exactly the same after 1945",
      "Globalization eliminated all U.S. jobs",
      "Economic change only occurred during the Progressive Era"
    ],
    answer:"Globalization and restructuring changed the U.S. economy, creating new opportunities and new challenges",
    hint:{ why:"CS32 focuses on major late-20th/early-21st economic shifts and impacts.", keyPoints:["Globalization","Restructuring","Impacts"] }
  },

  /* -------------------- CS33 (10) -------------------- */
  {
    cs:"CS33",
    prompt:"Which statement best explains how the internet changed American society?",
    choices:[
      "It increased access to information and changed communication, work, and politics",
      "It ended all forms of communication",
      "It eliminated the need for businesses",
      "It stopped the spread of media"
    ],
    answer:"It increased access to information and changed communication, work, and politics",
    hint:{ why:"The internet reshaped information access and social/political interaction.", keyPoints:["Information access","Communication change"] }
  },
  {
    cs:"CS33",
    prompt:"Which trend is most associated with demographic change in contemporary America?",
    choices:[
      "Increasing diversity due to immigration and changing birth rates",
      "A permanent end to migration",
      "A return to 1800 population patterns",
      "The elimination of cities"
    ],
    answer:"Increasing diversity due to immigration and changing birth rates",
    hint:{ why:"Demographic shifts include diversity changes and population movement patterns.", keyPoints:["Diversity","Demographics"] }
  },
  {
    cs:"CS33",
    prompt:"Cause → effect: The rise of social media most directly contributed to:",
    choices:[
      "Faster spread of information and increased debates about misinformation and privacy",
      "An end to political discussion",
      "A disappearance of advertising",
      "A complete stop to news reporting"
    ],
    answer:"Faster spread of information and increased debates about misinformation and privacy",
    hint:{ why:"Social media accelerates information flow and raises accuracy/privacy concerns.", keyPoints:["Speed","Misinformation","Privacy"] }
  },
  {
    cs:"CS33",
    prompt:"Which issue best illustrates a challenge created by rapid technological change?",
    choices:[
      "Debates over data privacy and cybersecurity",
      "A return to handwritten-only records",
      "An end to electricity use",
      "Eliminating all computers"
    ],
    answer:"Debates over data privacy and cybersecurity",
    hint:{ why:"Digital life increases privacy and security risks and policy debates.", keyPoints:["Privacy","Cybersecurity"] }
  },
  {
    cs:"CS33",
    prompt:"Which scenario best shows how demographic change can affect local communities?",
    choices:[
      "Schools and services adjust to new languages, cultures, and population needs",
      "Communities never change when populations shift",
      "Local governments stop providing services",
      "Population change has no effect on schools"
    ],
    answer:"Schools and services adjust to new languages, cultures, and population needs",
    hint:{ why:"Population shifts can change service needs, schooling, and politics.", keyPoints:["Schools","Services","Community change"] }
  },
  {
    cs:"CS33",
    prompt:"Which best describes a social challenge linked to economic and technological change?",
    choices:[
      "Unequal access to technology and opportunity can widen gaps between groups",
      "Everyone receives equal access automatically",
      "Technology eliminates the need for jobs",
      "Economic change always lowers inequality"
    ],
    answer:"Unequal access to technology and opportunity can widen gaps between groups",
    hint:{ why:"Access and opportunity can be uneven, shaping outcomes.", keyPoints:["Digital divide","Opportunity gaps"] }
  },
  {
    cs:"CS33",
    prompt:"Which statement best explains why polarization is often discussed in contemporary politics?",
    choices:[
      "Citizens and parties can become more divided in beliefs, affecting compromise and governance",
      "Polarization means everyone agrees",
      "Polarization ends elections",
      "Polarization only happens during wartime"
    ],
    answer:"Citizens and parties can become more divided in beliefs, affecting compromise and governance",
    hint:{ why:"Polarization can increase conflict and reduce compromise.", keyPoints:["Division","Compromise challenges"] }
  },
  {
    cs:"CS33",
    prompt:"Which example best shows a continuity in American civic life despite new technology?",
    choices:[
      "People still organize, debate issues, and influence policy—now often using digital tools",
      "Civic participation ended after the internet began",
      "Voting no longer exists",
      "Courts stopped hearing cases"
    ],
    answer:"People still organize, debate issues, and influence policy—now often using digital tools",
    hint:{ why:"Methods change, but civic engagement continues through new platforms.", keyPoints:["Engagement","New tools"] }
  },
  {
    cs:"CS33",
    prompt:"A student says, “Technology only affects entertainment.” Which correction is strongest?",
    choices:[
      "Technology affects work, education, politics, privacy, and the economy—not just entertainment",
      "Technology is illegal in schools",
      "Technology ended economic growth",
      "Technology only matters in 1800s factories"
    ],
    answer:"Technology affects work, education, politics, privacy, and the economy—not just entertainment",
    hint:{ why:"Tech has broad effects across society.", keyPoints:["Work","Education","Politics","Privacy"] }
  },
  {
    cs:"CS33",
    prompt:"Which statement BEST summarizes CS33?",
    choices:[
      "Social, demographic, and technological changes reshaped American life and created new opportunities and challenges",
      "American society stopped changing after WWII",
      "Demographic change ended in 1965",
      "Technology eliminated the need for civic participation"
    ],
    answer:"Social, demographic, and technological changes reshaped American life and created new opportunities and challenges",
    hint:{ why:"CS33 focuses on how modern changes affect society and civic life.", keyPoints:["Societal change","Opportunities","Challenges"] }
  }
]);

/* =========
   ENGINE — includes your choice-shuffle fix
   ========= */
const $ = (s)=>document.querySelector(s);
const screens = { start: $("#screenStart"), game: $("#screenGame"), done: $("#screenDone") };
const meta = { name: $("#mName"), start: $("#mStart"), time: $("#mTime"), acc: $("#mAcc") };
const qUI = {
  kicker: $("#qKicker"), text: $("#qText"), choices: $("#choices"),
  count: $("#qCount"), total: $("#qTotal"), bar: $("#barFill"),
  feedback: $("#feedback"),
  hintBox: $("#hintBox"), hintText: $("#hintText"), hintSmall: $("#hintSmall")
};

let state = {
  startedAt:null, timerId:null,
  idx:0, misses:0, attempts:0,
  qOrder:[]
};

$("#btnDemo").addEventListener("click", ()=>{ $("#name").value="Demo Student"; $("#name").focus(); });
$("#btnStart").addEventListener("click", startGame);
$("#btnReset").addEventListener("click", resetAll);
$("#btnPlayAgain").addEventListener("click", resetAll);
$("#btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("#logOut").innerText);
    $("#btnCopy").textContent="Copied ✅";
    setTimeout(()=>$("#btnCopy").textContent="Copy Ticket", 1100);
  }catch(e){
    alert("Copy failed. You can manually select and copy the ticket text.");
  }
});

function calcAccuracy(){
  if(state.attempts <= 0) return 100;
  return Math.round(((state.attempts - state.misses) / state.attempts) * 100);
}
function updateAccuracy(){
  meta.acc.textContent = `${calcAccuracy()}%`;
}

/* ✅ Your fix: shuffle answer choices each render */
function shuffledChoices(q){
  const arr = [...q.choices];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function startGame(){
  const n = ($("#name").value||"").trim();
  if(!n){ alert("Please enter your name."); return; }

  state.startedAt = new Date();
  meta.name.textContent = n;
  meta.start.textContent = stamp(state.startedAt);
  meta.time.textContent = "00:00";

  state.qOrder = shuffle([...QUESTIONS]);
  state.idx = 0;
  state.misses = 0;
  state.attempts = 0;

  $("#qTotal").textContent = String(state.qOrder.length);
  updateAccuracy();

  switchTo("game");
  startTimer();
  renderQuestion();
}

function renderQuestion(){
  const q = state.qOrder[state.idx];
  if(!q) return finish();

  qUI.kicker.textContent = `${q.cs} • Question ${state.idx+1}`;
  qUI.text.textContent = q.prompt;

  qUI.count.textContent = String(state.idx+1);
  qUI.total.textContent = String(state.qOrder.length);
  qUI.bar.style.width = `${Math.round((state.idx/state.qOrder.length)*100)}%`;

  qUI.feedback.textContent = "Choose the best answer.";
  qUI.feedback.style.color = "var(--muted)";

  qUI.hintBox.style.display = "none";
  qUI.hintText.textContent = "";
  qUI.hintSmall.textContent = "";

  qUI.choices.innerHTML = "";
  shuffledChoices(q).forEach(choice=>{
    const btn = document.createElement("button");
    btn.textContent = choice;
    btn.addEventListener("click", ()=>submit(choice));
    qUI.choices.appendChild(btn);
  });
}

function submit(choice){
  const q = state.qOrder[state.idx];

  state.attempts++;
  updateAccuracy();

  if(choice === q.answer){
    qUI.feedback.textContent = "Correct ✅";
    qUI.feedback.style.color = "var(--good)";
    flashButtons(choice, true);
    setTimeout(()=>{
      state.idx++;
      renderQuestion();
    }, 320);
    return;
  }

  state.misses++;
  updateAccuracy();

  qUI.feedback.textContent = "Not yet ❌ Try again.";
  qUI.feedback.style.color = "var(--bad)";
  flashButtons(choice, false);

  qUI.hintBox.style.display = "block";
  qUI.hintText.textContent = q.hint?.why || "Think back to the content elaboration details.";
  qUI.hintSmall.textContent = q.hint?.keyPoints?.length
    ? ("Key points: " + q.hint.keyPoints.join(" • "))
    : "";
}

function finish(){
  stopTimer();
  qUI.bar.style.width = "100%";

  const endedAt = new Date();
  const durationSec = Math.floor((endedAt - state.startedAt)/1000);
  const accuracy = calcAccuracy();

  if(state.misses > 0){
    $("#doneTitle").textContent = "Not Passed ❌";
    $("#doneMsg").textContent = "You finished, but this attempt had misses. Retake for a perfect run to earn the submit ticket.";
    $("#btnCopy").style.display = "none";

    $("#logOut").textContent =
`NOT PASSED — Retake Required

Student: ${meta.name.textContent}
Started: ${stamp(state.startedAt)}
Ended:   ${stamp(endedAt)}
Duration (sec): ${durationSec}
Accuracy: ${accuracy}%
Misses: ${state.misses}

RULE: To earn a submit ticket, you must complete the game with 0 misses (100% accuracy).`;
    switchTo("done");
    return;
  }

  $("#doneTitle").textContent = "Complete ✅";
  $("#doneMsg").textContent = "Perfect run achieved (0 misses). Copy your submit ticket.";
  $("#btnCopy").style.display = "inline-flex";

  const ticket = {
    status: "PASSED",
    game: "American History — Block 10 (CS 31–33)",
    student: meta.name.textContent,
    started: stamp(state.startedAt),
    ended: stamp(endedAt),
    duration_seconds: durationSec,
    total_questions: state.qOrder.length,
    total_attempts: state.attempts,
    misses: state.misses,
    accuracy_percent: 100
  };

  $("#logOut").textContent = JSON.stringify(ticket, null, 2);
  switchTo("done");
}

function switchTo(which){
  Object.values(screens).forEach(el=>el.classList.add("hidden"));
  screens[which].classList.remove("hidden");
}

function startTimer(){
  stopTimer();
  state.timerId = setInterval(()=>{
    const s = Math.floor((new Date() - state.startedAt)/1000);
    meta.time.textContent = fmtTime(s);
  }, 250);
}
function stopTimer(){
  if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
}

function resetAll(){
  stopTimer();
  meta.name.textContent="—";
  meta.start.textContent="—";
  meta.time.textContent="00:00";
  meta.acc.textContent="100%";
  $("#name").value="";
  $("#btnCopy").textContent="Copy Ticket";
  $("#btnCopy").style.display = "inline-flex";
  switchTo("start");
}

function fmtTime(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stamp(d){
  return d.toLocaleString(undefined, {
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function flashButtons(choice, correct){
  [...qUI.choices.querySelectorAll("button")].forEach(b=>{
    if(b.textContent === choice){
      b.classList.add(correct ? "good" : "bad");
      setTimeout(()=>b.classList.remove("good","bad"), 320);
    }
  });
}
</script>
</body>
</html>
