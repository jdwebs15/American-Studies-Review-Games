<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>American History — Block 10 (CS 31–33) Game</title>
<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --ink:#e7eefc; --muted:#a8b4cf;
    --accent:#7aa2ff; --good:#2bd576; --bad:#ff5c7a; --warn:#ffd166;
    --border:rgba(255,255,255,.12); --shadow:0 18px 55px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1000px 650px at 18% 12%, rgba(122,162,255,.18), transparent 60%), var(--bg);
    color:var(--ink); min-height:100vh;
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{width:min(980px,100%); background:rgba(17,26,46,.9); border:1px solid var(--border);
    border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden}
  header{padding:16px 18px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), transparent)}
  .title{display:flex; flex-direction:column; gap:4px}
  .title h1{margin:0; font-size:16px; letter-spacing:.2px}
  .title .sub{color:var(--muted); font-size:12px; line-height:1.3}
  .meta{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
  .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); background:rgba(0,0,0,.18)}
  .pill b{color:var(--ink); font-weight:700}
  main{padding:18px; display:grid; gap:14px}
  .card{background:rgba(0,0,0,.22); border:1px solid var(--border); border-radius:var(--r); padding:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  label{font-size:12px; color:var(--muted)}
  input[type="text"]{
    width:min(420px,100%); padding:10px 12px; border-radius:12px;
    border:1px solid var(--border); background:rgba(0,0,0,.25); color:var(--ink);
    outline:none;
  }
  button{
    cursor:pointer; border:none; border-radius:14px; padding:12px 12px;
    font-weight:800; color:var(--ink); background:rgba(122,162,255,.18);
    border:1px solid rgba(122,162,255,.35);
    transition:transform .08s ease, filter .12s ease;
  }
  button:hover{filter:brightness(1.06)}
  button:active{transform:scale(.99)}
  button.secondary{background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--muted)}
  button.good{background:rgba(43,213,118,.14); border:1px solid rgba(43,213,118,.35)}
  button.bad{background:rgba(255,92,122,.14); border:1px solid rgba(255,92,122,.35)}
  .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
  .kicker{color:var(--muted); font-size:12px}
  .qTitle{margin:0; font-size:14px; line-height:1.35}
  .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .bar{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--border); width:220px}
  .bar>div{height:100%; width:0%; background:rgba(43,213,118,.75)}
  .grid{
    display:grid; gap:10px; margin-top:10px;
    grid-template-columns:repeat(2, minmax(0,1fr));
  }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .hint{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    background:rgba(255,209,102,.10); border:1px solid rgba(255,209,102,.35);
    display:none;
  }
  .hint .small{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}
  .toast{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:rgba(0,0,0,.25); border:1px solid var(--border); padding:12px; border-radius:14px;
    color:var(--ink); font-size:12px; line-height:1.35; margin:10px 0 0;
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="American History Block 10 Game">
  <header>
    <div class="title">
      <h1>American History — Block 10 Game (CS 31–33)</h1>
      <div class="sub">CS31: Globalization & economic restructuring • CS32: Domestic policy challenges post-9/11 • CS33: Foreign policy challenges post-9/11 • Perfect run required</div>
    </div>
    <div class="meta">
      <div class="pill">Name: <b id="mName">—</b></div>
      <div class="pill">Started: <b id="mStart">—</b></div>
      <div class="pill">Time: <b id="mTime">00:00</b></div>
      <div class="pill">Accuracy: <b id="mAcc">100%</b></div>
    </div>
  </header>

  <main>
    <section id="screenStart" class="card">
      <div class="row">
        <div>
          <div class="kicker">Enter your name to begin</div>
          <div style="margin-top:8px">
            <label for="name">Student Name</label><br/>
            <input id="name" type="text" autocomplete="name" placeholder="Type your name…" />
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="btnStart">Start</button>
          <button id="btnDemo" class="secondary">Demo</button>
        </div>
      </div>
      <div class="toast" style="margin-top:10px">
        Rules: hints only after a miss • <b>miss counts once per question</b> • choices reshuffle after miss • must finish with 0 missed questions to earn ticket.
      </div>
    </section>

    <section id="screenGame" class="card hidden">
      <div class="qTop">
        <div>
          <div class="kicker" id="qKicker">Question</div>
          <p class="qTitle" id="qText">—</p>
        </div>
        <div class="status">
          <div class="bar"><div id="barFill"></div></div>
          <div class="toast"><span id="qCount">0</span>/<span id="qTotal">0</span></div>
        </div>
      </div>

      <div class="grid" id="choices"></div>

      <div class="hint" id="hintBox" role="note" aria-label="Hint">
        <div><b>Hint (only after a miss):</b></div>
        <div id="hintText" style="margin-top:6px"></div>
        <div class="small" id="hintSmall"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="toast" id="feedback">—</div>
        <div style="display:flex; gap:10px">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </div>
    </section>

    <section id="screenDone" class="card hidden">
      <div class="row">
        <div>
          <h2 id="doneTitle" style="margin:0 0 6px; font-size:16px;">Complete ✅</h2>
          <div class="toast" id="doneMsg">Perfect run achieved. Copy your submit ticket.</div>
        </div>
        <div style="display:flex; gap:10px">
          <button id="btnCopy" class="good">Copy Ticket</button>
          <button id="btnPlayAgain" class="secondary">Play Again</button>
        </div>
      </div>
      <pre id="logOut"></pre>
    </section>
  </main>
</div>

<script>
/* =========================================================
   QUESTIONS — Block 10 (CS 31–33) — 30 items (balanced)
   CS31 (10): Globalization / trade / overseas competition / restructuring
   CS32 (10): Domestic policy challenges post–Cold War & post-9/11
   CS33 (10): Foreign policy challenges post–Cold War & post-9/11
   ========================================================= */

const QUESTIONS = shuffle([

  /* -------------------- CS31 (10) — ECONOMY / GLOBALIZATION -------------------- */
  {
    cs:"CS31",
    prompt:"Which development BEST represents globalization’s impact on the U.S. economy?",
    choices:[
      "International trade and overseas competition increased pressure on U.S. producers",
      "The U.S. ended all imports and exports permanently",
      "All jobs became agricultural again",
      "Competition between companies disappeared"
    ],
    answer:"International trade and overseas competition increased pressure on U.S. producers",
    hint:{ why:"CS31 highlights trade and overseas competition challenging U.S. producers and communities.", keyPoints:["Trade","Overseas competition","Pressure on producers"] }
  },
  {
    cs:"CS31",
    prompt:"Which outcome is MOST associated with increased overseas competition for American producers?",
    choices:[
      "Closing of some factories and a decrease in manufacturing jobs",
      "A guaranteed rise in manufacturing employment everywhere",
      "A nationwide ban on foreign goods",
      "The elimination of the service sector"
    ],
    answer:"Closing of some factories and a decrease in manufacturing jobs",
    hint:{ why:"CS31 notes factory closings and fewer manufacturing jobs in many communities.", keyPoints:["Plant closings","Manufacturing decline"] }
  },
  {
    cs:"CS31",
    prompt:"Which shift in the U.S. economy is commonly linked to globalization and restructuring?",
    choices:[
      "A shift from manufacturing toward service industries",
      "A shift from services back to frontier trading posts",
      "An end to business ownership",
      "A return to barter with no money"
    ],
    answer:"A shift from manufacturing toward service industries",
    hint:{ why:"CS31 includes the shift from manufacturing toward service work.", keyPoints:["Restructuring","Service economy"] }
  },
  {
    cs:"CS31",
    prompt:"Cause → effect: Growth in transnational business organizations and global trade MOST directly contributed to:",
    choices:[
      "Changes in local job markets as companies moved work and supply chains across borders",
      "An end to all consumer choice in the U.S.",
      "Guaranteed identical wages worldwide",
      "The abolition of technology jobs"
    ],
    answer:"Changes in local job markets as companies moved work and supply chains across borders",
    hint:{ why:"Global firms and trade can reshape where jobs are located and how goods are made.", keyPoints:["Transnational firms","Job shifts","Supply chains"] }
  },
  {
    cs:"CS31",
    prompt:"Which trend is MOST closely tied to economic restructuring in the U.S. since the late 1900s?",
    choices:[
      "Growth in lower-paying jobs in some sectors",
      "Only higher-paying jobs in every region",
      "No change in wages or employment patterns",
      "The disappearance of all corporations"
    ],
    answer:"Growth in lower-paying jobs in some sectors",
    hint:{ why:"CS31 notes growth in lower-paying jobs as part of restructuring effects.", keyPoints:["Lower-paying jobs","Restructuring"] }
  },
  {
    cs:"CS31",
    prompt:"Which sector is identified as growing as the economy shifted away from manufacturing?",
    choices:[
      "Information technology jobs",
      "Horse-and-buggy repair shops",
      "Subsistence farming",
      "Blacksmithing"
    ],
    answer:"Information technology jobs",
    hint:{ why:"CS31 highlights growth in information technology jobs.", keyPoints:["IT growth","New economy"] }
  },
  {
    cs:"CS31",
    prompt:"Which statement BEST explains why a U.S. trade deficit can grow in a globalized economy?",
    choices:[
      "The U.S. can import more goods than it exports in value",
      "The U.S. stops trading with other countries",
      "Imports are illegal under the Constitution",
      "Trade deficits only happen during wartime"
    ],
    answer:"The U.S. can import more goods than it exports in value",
    hint:{ why:"A trade deficit occurs when imports exceed exports in value.", keyPoints:["Imports vs exports","Trade deficit"] }
  },
  {
    cs:"CS31",
    prompt:"Which example BEST shows how globalization can affect local communities?",
    choices:[
      "A plant closes after facing international competition, changing local employment",
      "A community bans all technology",
      "A city eliminates schools to reduce costs",
      "A town becomes isolated from all markets"
    ],
    answer:"A plant closes after facing international competition, changing local employment",
    hint:{ why:"CS31 emphasizes impacts on producers and local communities, including plant closings.", keyPoints:["Local impact","Plant closing"] }
  },
  {
    cs:"CS31",
    prompt:"A student says, “Globalization only benefits the U.S.” Which correction is strongest?",
    choices:[
      "Globalization creates benefits and challenges, including job shifts and competition pressures",
      "Globalization guarantees no economic change",
      "Globalization ended competition completely",
      "Globalization only affects sports"
    ],
    answer:"Globalization creates benefits and challenges, including job shifts and competition pressures",
    hint:{ why:"CS31 stresses mixed effects: new opportunities AND real disruptions.", keyPoints:["Benefits + challenges","Competition","Job shifts"] }
  },
  {
    cs:"CS31",
    prompt:"Which statement BEST summarizes CS31?",
    choices:[
      "Global trade and overseas competition reshaped U.S. jobs and industries, impacting producers and communities",
      "The U.S. economy stayed unchanged by global trade",
      "Manufacturing expanded everywhere with no disruptions",
      "Globalization eliminated all U.S. exports"
    ],
    answer:"Global trade and overseas competition reshaped U.S. jobs and industries, impacting producers and communities",
    hint:{ why:"CS31 focuses on global trade/competition and the resulting restructuring impacts.", keyPoints:["Global trade","Competition","Restructuring"] }
  },

  /* -------------------- CS32 (10) — DOMESTIC POLICY CHALLENGES -------------------- */
  {
    cs:"CS32",
    prompt:"Which domestic challenge after September 11, 2001 involved balancing national security with civil liberties?",
    choices:[
      "Debates about the USA PATRIOT Act",
      "The Louisiana Purchase",
      "The Homestead Act",
      "The Emancipation Proclamation"
    ],
    answer:"Debates about the USA PATRIOT Act",
    hint:{ why:"CS32 includes the tension between security and civil liberties (PATRIOT Act).", keyPoints:["Security vs liberty","PATRIOT Act"] }
  },
  {
    cs:"CS32",
    prompt:"Which agency was created to address transportation security concerns after 9/11?",
    choices:[
      "Transportation Security Administration (TSA)",
      "Federal Reserve",
      "National Park Service",
      "Peace Corps"
    ],
    answer:"Transportation Security Administration (TSA)",
    hint:{ why:"CS32 specifically lists creation of the TSA as a national security response.", keyPoints:["TSA","Transportation security"] }
  },
  {
    cs:"CS32",
    prompt:"Cause → effect: After 9/11, one domestic social effect noted in the model curriculum was:",
    choices:[
      "An increase in Islamophobia and xenophobia",
      "A complete end to discrimination",
      "A ban on political debate nationwide",
      "The elimination of airport travel"
    ],
    answer:"An increase in Islamophobia and xenophobia",
    hint:{ why:"CS32 identifies increased Islamophobia/xenophobia as a domestic challenge.", keyPoints:["Islamophobia","Xenophobia"] }
  },
  {
    cs:"CS32",
    prompt:"Which issue is MOST directly connected to fears of domestic terrorism as a post-9/11 domestic challenge?",
    choices:[
      "Heightened concern about attacks within the U.S.",
      "Ending all federal law enforcement",
      "Abolishing national borders",
      "Eliminating elections"
    ],
    answer:"Heightened concern about attacks within the U.S.",
    hint:{ why:"CS32 mentions increasing fears of domestic terrorism as a domestic issue.", keyPoints:["Domestic terrorism fears","Security"] }
  },
  {
    cs:"CS32",
    prompt:"Which pair BEST reflects a continuing domestic debate about state vs. federal roles in policy?",
    choices:[
      "Gun rights and gun control",
      "The geography of the Great Plains",
      "The construction of the Erie Canal",
      "The causes of the French and Indian War"
    ],
    answer:"Gun rights and gun control",
    hint:{ why:"CS32 lists disagreements over gun rights/control within state-federal debates.", keyPoints:["State vs federal debate","Gun policy"] }
  },
  {
    cs:"CS32",
    prompt:"Which issue below is included as part of the continuing state vs. federal debate in the post–Cold War era?",
    choices:[
      "Health care",
      "Territorial expansion into the Louisiana Territory",
      "The abolition of slavery in 1865",
      "The creation of the Articles of Confederation"
    ],
    answer:"Health care",
    hint:{ why:"CS32 names health care among major modern domestic policy debates.", keyPoints:["Health care","Domestic policy"] }
  },
  {
    cs:"CS32",
    prompt:"Which is an example of a social/political issue included in modern domestic policy disagreements?",
    choices:[
      "LGBTQ+ rights",
      "The invention of the cotton gin",
      "The building of the transcontinental railroad",
      "The ratification of the 15th Amendment"
    ],
    answer:"LGBTQ+ rights",
    hint:{ why:"CS32 explicitly includes LGBTQ+ rights in state/federal debate topics.", keyPoints:["LGBTQ+ rights","Policy debate"] }
  },
  {
    cs:"CS32",
    prompt:"Which economic issue is identified as a major domestic challenge in the post–Cold War era?",
    choices:[
      "The mortgage crisis and government bailouts",
      "The Panic of 1837",
      "The creation of the first colonies",
      "The Dust Bowl of the 1930s"
    ],
    answer:"The mortgage crisis and government bailouts",
    hint:{ why:"CS32 lists mortgage crisis and government bailouts as modern domestic economic issues.", keyPoints:["Mortgage crisis","Bailouts"] }
  },
  {
    cs:"CS32",
    prompt:"Which change is connected to domestic economic challenges after the Cold War?",
    choices:[
      "A decrease in defense spending after the Cold War",
      "A permanent end to government spending",
      "A ban on private banking",
      "The elimination of taxes nationwide"
    ],
    answer:"A decrease in defense spending after the Cold War",
    hint:{ why:"CS32 notes a post–Cold War decrease in defense spending among domestic economic issues.", keyPoints:["Defense spending","Post–Cold War economy"] }
  },
  {
    cs:"CS32",
    prompt:"Which statement BEST summarizes CS32?",
    choices:[
      "U.S. domestic policy faced new security, social, political, and economic challenges after the Cold War and 9/11",
      "Domestic policy ended after 1991",
      "Only foreign policy changed after 2001",
      "Domestic issues were limited to westward expansion"
    ],
    answer:"U.S. domestic policy faced new security, social, political, and economic challenges after the Cold War and 9/11",
    hint:{ why:"CS32 focuses on domestic challenges: security/liberty, social tensions, policy debates, and economic shocks.", keyPoints:["Domestic challenges","Post-9/11","Economy"] }
  },

  /* -------------------- CS33 (10) — FOREIGN POLICY CHALLENGES -------------------- */
  {
    cs:"CS33",
    prompt:"Which foreign policy challenge is MOST connected to economic globalization in the model curriculum?",
    choices:[
      "Balancing trade and the balance of trade in a global economy",
      "Ending all international travel permanently",
      "Eliminating international currencies",
      "Banning all imports and exports by law"
    ],
    answer:"Balancing trade and the balance of trade in a global economy",
    hint:{ why:"CS33 lists economic challenges including balance of trade and global partnerships.", keyPoints:["Balance of trade","Global economy"] }
  },
  {
    cs:"CS33",
    prompt:"Which international partnerships/organizations are listed as examples of economic connections in a globalized world?",
    choices:[
      "World Economic Forum and World Trade Organization",
      "NAACP and SNCC",
      "FDA and EPA",
      "CIA and FBI"
    ],
    answer:"World Economic Forum and World Trade Organization",
    hint:{ why:"CS33 explicitly names WEF and WTO as examples of international economic partnerships.", keyPoints:["WEF","WTO","Partnerships"] }
  },
  {
    cs:"CS33",
    prompt:"Cause → effect: Globalization created political and social challenges for U.S. foreign policy such as:",
    choices:[
      "Pandemic diseases and refugee migration from war-torn regions",
      "Ending all humanitarian concerns worldwide",
      "Guaranteeing no migration across borders",
      "Stopping the spread of disease permanently"
    ],
    answer:"Pandemic diseases and refugee migration from war-torn regions",
    hint:{ why:"CS33 includes pandemics and refugee migration as global social/political challenges.", keyPoints:["Pandemics","Refugees"] }
  },
  {
    cs:"CS33",
    prompt:"Which is an example of a foreign policy challenge involving values and law during conflict?",
    choices:[
      "Debates over the treatment of enemy combatants",
      "The regulation of local school lunch menus",
      "The location of state capitals",
      "The building of interstate highways"
    ],
    answer:"Debates over the treatment of enemy combatants",
    hint:{ why:"CS33 highlights debate over how enemy combatants should be treated.", keyPoints:["Enemy combatants","Law/values"] }
  },
  {
    cs:"CS33",
    prompt:"Which military-related impact is connected to the War on Terror?",
    choices:[
      "Increased defense spending as a result of the war on terrorism",
      "A permanent elimination of the U.S. military",
      "A ban on all intelligence gathering",
      "Ending all alliances worldwide"
    ],
    answer:"Increased defense spending as a result of the war on terrorism",
    hint:{ why:"CS33 notes increased defense spending linked to the war on terrorism.", keyPoints:["War on terror","Defense spending"] }
  },
  {
    cs:"CS33",
    prompt:"Which statement BEST describes a foreign policy challenge involving international cooperation in the Middle East?",
    choices:[
      "Debates about the roles of the United States and the United Nations in addressing unrest",
      "A plan to end the UN worldwide",
      "A policy to avoid all diplomacy forever",
      "A requirement that states run U.S. foreign policy"
    ],
    answer:"Debates about the roles of the United States and the United Nations in addressing unrest",
    hint:{ why:"CS33 includes the role of the U.S. and UN in addressing Middle East unrest.", keyPoints:["U.S. + UN roles","Middle East unrest"] }
  },
  {
    cs:"CS33",
    prompt:"Which issue BEST reflects foreign policy concerns about global stability and security?",
    choices:[
      "Control of weapons of mass destruction in regions seen as threats",
      "A city passing a local noise ordinance",
      "Scheduling school calendars",
      "Funding a new public park"
    ],
    answer:"Control of weapons of mass destruction in regions seen as threats",
    hint:{ why:"CS33 identifies WMD control as a major foreign policy/security challenge.", keyPoints:["WMD control","Global stability"] }
  },
  {
    cs:"CS33",
    prompt:"Which economic factor is listed as part of foreign policy challenges in a globalized world?",
    choices:[
      "International demand for the U.S. dollar",
      "A permanent ban on currency exchange",
      "Eliminating banking systems worldwide",
      "Outlawing international markets"
    ],
    answer:"International demand for the U.S. dollar",
    hint:{ why:"CS33 names international demand for the U.S. dollar among economic challenges.", keyPoints:["U.S. dollar demand","Global economy"] }
  },
  {
    cs:"CS33",
    prompt:"Which statement BEST connects outsourcing to foreign policy challenges in a globalized world?",
    choices:[
      "Global economic ties can encourage companies to move some jobs overseas",
      "Outsourcing only happened in the 1800s",
      "Outsourcing is unrelated to global trade",
      "Outsourcing guarantees higher U.S. manufacturing employment"
    ],
    answer:"Global economic ties can encourage companies to move some jobs overseas",
    hint:{ why:"CS33 includes outsourcing of U.S. jobs as an economic challenge of globalization.", keyPoints:["Outsourcing","Global ties"] }
  },
  {
    cs:"CS33",
    prompt:"Which statement BEST summarizes CS33?",
    choices:[
      "U.S. foreign policy faced economic, social, political, and military challenges after the Cold War and 9/11",
      "Foreign policy ended after 2001",
      "Only domestic policy changed after the Cold War",
      "Foreign policy focused mainly on westward expansion"
    ],
    answer:"U.S. foreign policy faced economic, social, political, and military challenges after the Cold War and 9/11",
    hint:{ why:"CS33 is explicitly foreign policy challenges in the post-Cold War and post-9/11 world.", keyPoints:["Foreign policy","Global challenges","Post-9/11"] }
  }

]);

/* =========
   ENGINE — FIRST-TRY ACCURACY STANDARD (Block 7 style)
   ========= */
const $ = (s)=>document.querySelector(s);
const screens = { start: $("#screenStart"), game: $("#screenGame"), done: $("#screenDone") };
const meta = { name: $("#mName"), start: $("#mStart"), time: $("#mTime"), acc: $("#mAcc") };
const qUI = {
  kicker: $("#qKicker"), text: $("#qText"), choices: $("#choices"),
  count: $("#qCount"), total: $("#qTotal"), bar: $("#barFill"),
  feedback: $("#feedback"),
  hintBox: $("#hintBox"), hintText: $("#hintText"), hintSmall: $("#hintSmall")
};

let state = {
  startedAt:null, timerId:null,
  idx:0,
  questionsCompleted:0,
  correctFirst:0,
  misses:0,                 // counts ONCE per question
  missedThisQuestion:false,
  qOrder:[]
};

$("#btnDemo").addEventListener("click", ()=>{ $("#name").value="Demo Student"; $("#name").focus(); });
$("#btnStart").addEventListener("click", startGame);
$("#btnReset").addEventListener("click", resetAll);
$("#btnPlayAgain").addEventListener("click", resetAll);
$("#btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("#logOut").innerText);
    $("#btnCopy").textContent="Copied ✅";
    setTimeout(()=>$("#btnCopy").textContent="Copy Ticket", 1100);
  }catch(e){
    alert("Copy failed. You can manually select and copy the ticket text.");
  }
});

function calcAccuracy(){
  if(state.questionsCompleted <= 0) return 100;
  return Math.round((state.correctFirst / state.questionsCompleted) * 100);
}
function updateAccuracy(){
  meta.acc.textContent = `${calcAccuracy()}%`;
}

function shuffledChoices(q){
  const arr = [...q.choices];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function startGame(){
  const n = ($("#name").value||"").trim();
  if(!n){ alert("Please enter your name."); return; }

  state.startedAt = new Date();
  meta.name.textContent = n;
  meta.start.textContent = stamp(state.startedAt);
  meta.time.textContent = "00:00";

  state.qOrder = shuffle([...QUESTIONS]);
  state.idx = 0;
  state.questionsCompleted = 0;
  state.correctFirst = 0;
  state.misses = 0;
  state.missedThisQuestion = false;

  $("#qTotal").textContent = String(state.qOrder.length);
  updateAccuracy();

  switchTo("game");
  startTimer();
  renderQuestion();
}

function renderQuestion(){
  const q = state.qOrder[state.idx];
  if(!q) return finish();

  state.missedThisQuestion = false;

  qUI.kicker.textContent = `${q.cs} • Question ${state.idx+1}`;
  qUI.text.textContent = q.prompt;

  qUI.count.textContent = String(state.idx+1);
  qUI.total.textContent = String(state.qOrder.length);
  qUI.bar.style.width = `${Math.round((state.idx/state.qOrder.length)*100)}%`;

  qUI.feedback.textContent = "Choose the best answer.";
  qUI.feedback.style.color = "var(--muted)";

  qUI.hintBox.style.display = "none";
  qUI.hintText.textContent = "";
  qUI.hintSmall.textContent = "";

  drawChoices(q);
}

function drawChoices(q){
  qUI.choices.innerHTML = "";
  shuffledChoices(q).forEach(choice=>{
    const btn = document.createElement("button");
    btn.textContent = choice;
    btn.addEventListener("click", ()=>submit(choice));
    qUI.choices.appendChild(btn);
  });
}

function submit(choice){
  const q = state.qOrder[state.idx];

  if(choice === q.answer){
    state.questionsCompleted++;
    if(!state.missedThisQuestion) state.correctFirst++;
    updateAccuracy();

    qUI.feedback.textContent = "Correct ✅";
    qUI.feedback.style.color = "var(--good)";
    flashButtons(choice, true);

    setTimeout(()=>{
      state.idx++;
      renderQuestion();
    }, 320);
    return;
  }

  if(!state.missedThisQuestion){
    state.misses++;
    state.missedThisQuestion = true;
    updateAccuracy();
  }

  qUI.feedback.textContent = "Not yet ❌ Try again.";
  qUI.feedback.style.color = "var(--bad)";
  flashButtons(choice, false);

  qUI.hintBox.style.display = "block";
  qUI.hintText.textContent = q.hint?.why || "Think back to the content elaboration details.";
  qUI.hintSmall.textContent = q.hint?.keyPoints?.length
    ? ("Key points: " + q.hint.keyPoints.join(" • "))
    : "";

  // ✅ reshuffle choices after a miss (and after any wrong click)
  drawChoices(q);
}

function finish(){
  stopTimer();
  qUI.bar.style.width = "100%";

  const endedAt = new Date();
  const durationSec = Math.floor((endedAt - state.startedAt)/1000);
  const accuracy = calcAccuracy();

  if(state.misses > 0){
    $("#doneTitle").textContent = "Not Passed ❌";
    $("#doneMsg").textContent = "You finished, but this attempt had missed questions. Retake for a perfect run to earn the submit ticket.";
    $("#btnCopy").style.display = "none";

    $("#logOut").textContent =
`NOT PASSED — Retake Required

Student: ${meta.name.textContent}
Started: ${stamp(state.startedAt)}
Ended:   ${stamp(endedAt)}
Duration (sec): ${durationSec}
First-try Accuracy: ${accuracy}%
Missed Questions: ${state.misses}

RULE: To earn a submit ticket, you must complete the game with 0 missed questions (100% first-try accuracy).`;
    switchTo("done");
    return;
  }

  $("#doneTitle").textContent = "Complete ✅";
  $("#doneMsg").textContent = "Perfect run achieved (0 missed questions). Copy your submit ticket.";
  $("#btnCopy").style.display = "inline-flex";

  const ticket = {
    status: "PASSED",
    game: "American History — Block 10 (CS 31–33)",
    student: meta.name.textContent,
    started: stamp(state.startedAt),
    ended: stamp(endedAt),
    duration_seconds: durationSec,
    total_questions: state.qOrder.length,
    questions_completed: state.questionsCompleted,
    missed_questions: state.misses,
    first_try_accuracy_percent: 100
  };

  $("#logOut").textContent = JSON.stringify(ticket, null, 2);
  switchTo("done");
}

function switchTo(which){
  Object.values(screens).forEach(el=>el.classList.add("hidden"));
  screens[which].classList.remove("hidden");
}

function startTimer(){
  stopTimer();
  state.timerId = setInterval(()=>{
    const s = Math.floor((new Date() - state.startedAt)/1000);
    meta.time.textContent = fmtTime(s);
  }, 250);
}
function stopTimer(){
  if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
}

function resetAll(){
  stopTimer();
  meta.name.textContent="—";
  meta.start.textContent="—";
  meta.time.textContent="00:00";
  meta.acc.textContent="100%";
  $("#name").value="";
  $("#btnCopy").textContent="Copy Ticket";
  $("#btnCopy").style.display = "inline-flex";
  switchTo("start");
}

function fmtTime(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stamp(d){
  return d.toLocaleString(undefined, {
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function flashButtons(choice, correct){
  [...qUI.choices.querySelectorAll("button")].forEach(b=>{
    if(b.textContent === choice){
      b.classList.add(correct ? "good" : "bad");
      setTimeout(()=>b.classList.remove("good","bad"), 320);
    }
  });
}
</script>
</body>
</html>
