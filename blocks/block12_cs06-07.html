<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>American History — Block 12 (CS 6–7) Game</title>

<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --ink:#e7eefc; --muted:#a8b4cf;
    --accent:#7aa2ff; --good:#2bd576; --bad:#ff5c7a; --warn:#ffd166;
    --border:rgba(255,255,255,.12); --shadow:0 18px 55px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1000px 650px at 18% 12%, rgba(122,162,255,.18), transparent 60%), var(--bg);
    color:var(--ink); min-height:100vh;
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{
    width:min(980px,100%); background:rgba(17,26,46,.9);
    border:1px solid var(--border); border-radius:var(--r);
    box-shadow:var(--shadow); overflow:hidden;
  }
  header{
    padding:16px 18px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), transparent);
  }
  .title{display:flex; flex-direction:column; gap:4px}
  .title h1{margin:0; font-size:16px}
  .title .sub{color:var(--muted); font-size:12px; line-height:1.35}
  .meta{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
  .pill{
    border:1px solid var(--border); border-radius:999px; padding:6px 10px;
    font-size:12px; color:var(--muted); background:rgba(0,0,0,.18)
  }
  .pill b{color:var(--ink); font-weight:800}
  main{padding:18px; display:grid; gap:14px}
  .card{
    background:rgba(0,0,0,.22); border:1px solid var(--border);
    border-radius:var(--r); padding:16px;
  }
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  label{font-size:12px; color:var(--muted)}
  input[type="text"]{
    width:min(420px,100%); padding:10px 12px; border-radius:12px;
    border:1px solid var(--border); background:rgba(0,0,0,.25); color:var(--ink);
    outline:none;
  }
  button{
    cursor:pointer; border:none; border-radius:14px; padding:12px 12px;
    font-weight:900; color:var(--ink); background:rgba(122,162,255,.18);
    border:1px solid rgba(122,162,255,.35);
    transition:transform .08s ease, filter .12s ease;
  }
  button:hover{filter:brightness(1.06)}
  button:active{transform:scale(.99)}
  button.secondary{background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--muted)}
  button.good{background:rgba(43,213,118,.14); border:1px solid rgba(43,213,118,.35)}
  button.bad{background:rgba(255,92,122,.14); border:1px solid rgba(255,92,122,.35)}
  .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
  .kicker{color:var(--muted); font-size:12px}
  .qTitle{margin:0; font-size:14px; line-height:1.4}
  .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .bar{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--border); width:220px}
  .bar>div{height:100%; width:0%; background:rgba(43,213,118,.75)}
  .grid{
    display:grid; gap:10px; margin-top:10px;
    grid-template-columns:repeat(2, minmax(0,1fr));
  }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .hint{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    background:rgba(255,209,102,.10); border:1px solid rgba(255,209,102,.35);
    display:none;
  }
  .hint .small{color:var(--muted); font-size:12px; margin-top:6px; line-height:1.35}
  .toast{font-size:12px; color:var(--muted)}
  .hidden{display:none!important}
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:rgba(0,0,0,.25); border:1px solid var(--border);
    padding:12px; border-radius:14px;
    color:var(--ink); font-size:12px; line-height:1.35; margin:10px 0 0;
  }
</style>
</head>

<body>
<div class="app" role="application" aria-label="American History Block 12 Game">
  <header>
    <div class="title">
      <h1>American History — Block 12 Game (CS 6–7)</h1>
      <div class="sub">Founding Documents • Constitution foundations + Federalist/Anti-Federalist debate • Perfect run required</div>
    </div>
    <div class="meta">
      <div class="pill">Name: <b id="mName">—</b></div>
      <div class="pill">Started: <b id="mStart">—</b></div>
      <div class="pill">Time: <b id="mTime">00:00</b></div>
      <div class="pill">Accuracy: <b id="mAcc">100%</b></div>
    </div>
  </header>

  <main>
    <section id="screenStart" class="card">
      <div class="row">
        <div>
          <div class="kicker">Enter your name to begin</div>
          <div style="margin-top:8px">
            <label for="name">Student Name</label><br/>
            <input id="name" type="text" autocomplete="name" placeholder="Type your name…" />
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="btnStart">Start</button>
          <button id="btnDemo" class="secondary">Demo</button>
        </div>
      </div>
      <div class="toast" style="margin-top:10px">
        Rules: hint only after a miss • <b>miss counts once per question</b> • choices reshuffle after miss • must finish with 0 missed questions to earn ticket.
      </div>
    </section>

    <section id="screenGame" class="card hidden">
      <div class="qTop">
        <div>
          <div class="kicker" id="qKicker">Question</div>
          <p class="qTitle" id="qText">—</p>
        </div>
        <div class="status">
          <div class="bar"><div id="barFill"></div></div>
          <div class="toast"><span id="qCount">0</span>/<span id="qTotal">0</span></div>
        </div>
      </div>

      <div class="grid" id="choices"></div>

      <div class="hint" id="hintBox" role="note" aria-label="Hint">
        <div><b>Hint (only after a miss):</b></div>
        <div id="hintText" style="margin-top:6px"></div>
        <div class="small" id="hintSmall"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="toast" id="feedback">—</div>
        <div style="display:flex; gap:10px">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </div>
    </section>

    <section id="screenDone" class="card hidden">
      <div class="row">
        <div>
          <h2 id="doneTitle" style="margin:0 0 6px; font-size:16px;">Complete ✅</h2>
          <div class="toast" id="doneMsg">Perfect run achieved. Copy your submit ticket.</div>
        </div>
        <div style="display:flex; gap:10px">
          <button id="btnCopy" class="good">Copy Ticket</button>
          <button id="btnPlayAgain" class="secondary">Play Again</button>
        </div>
      </div>
      <pre id="logOut"></pre>
    </section>
  </main>
</div>

<script>
/* =========
   QUESTIONS — Block 12 (CS 6–7)
   Updated to match test anchors:
   ✅ Article I = representative government
   ✅ Supremacy Clause
   ✅ Article IV / Full Faith and Credit
   ✅ Montesquieu / separation of powers
   ✅ Explicit checks & balances naming
   ========= */
const QUESTIONS = [
  // -------- CS6 (16) --------
  {
    cs:"CS6",
    prompt:"How does Article I of the U.S. Constitution reflect the framers’ commitment to representative government?",
    choices:[
      "It establishes a legislature whose members are elected to represent the people",
      "It creates a monarchy to lead the nation",
      "It requires all laws to be written by judges",
      "It removes elections to ensure stability"
    ],
    answer:"It establishes a legislature whose members are elected to represent the people",
    hint:{why:"Article I creates Congress and links it to elections/representation.", keyPoints:["Article I","Congress","Representation"]}
  },
  {
  cs:"CS6",
  prompt:"A couple is legally married in one state. When they move, another state refuses to recognize their marriage license. Which constitutional clause addresses this issue?",
  choices:[
    "Full Faith and Credit Clause",
    "Necessary and Proper Clause",
    "Commerce Clause",
    "Establishment Clause"
  ],
  answer:"Full Faith and Credit Clause",
  hint:{
    why:"The Full Faith and Credit Clause requires states to recognize public acts, records, and judicial decisions of other states.",
    keyPoints:["State-to-state recognition","Public acts","Legal records"]
  }
},
  {
  cs:"CS6",
  prompt:"A state passes a law that directly conflicts with a federal law. A court must decide which law applies. Which constitutional principle resolves this conflict?",
  choices:[
    "Supremacy Clause",
    "Reserved powers doctrine",
    "Popular sovereignty",
    "Electoral College"
  ],
  answer:"Supremacy Clause",
  hint:{
    why:"The Supremacy Clause establishes that federal law is the supreme law of the land when conflicts occur.",
    keyPoints:["Federal law prevails","Article VI","Conflict resolution"]
  }
},
  {
    cs:"CS6",
    prompt:"Which feature best shows the Constitution strengthened the national government compared with a looser system?",
    choices:[
      "It created three separate branches to carry out national responsibilities",
      "It removed elections so leaders could act quickly",
      "It banned amendments to keep government stable",
      "It ended all state governments"
    ],
    answer:"It created three separate branches to carry out national responsibilities",
    hint:{why:"A defined national structure (3 branches) strengthened national governance.", keyPoints:["3 branches","Stronger structure"]}
  },
  {
    cs:"CS6",
    prompt:"Which principle best describes how power is shared between the national government and the states?",
    choices:["Federalism","Judicial precedent","Mercantilism","Nativism"],
    answer:"Federalism",
    hint:{why:"Federalism divides powers between levels of government.", keyPoints:["National vs state powers","Shared authority"]}
  },
  {
    cs:"CS6",
    prompt:"Which two features were designed to prevent the concentration of power in one person? (Select two.)",
    choices:["Separation of powers","Checks and balances","Executive privilege","Unitary government"],
    answer:"Separation of powers",
    hint:{why:"On tests, this is typically separation of powers + checks and balances working together.", keyPoints:["Separation of powers","Checks and balances"]}
  },
  {
    cs:"CS6",
    prompt:"Which principle ensures that no single branch of government becomes too powerful?",
    choices:["Checks and balances","Judicial review","Popular sovereignty","Isolationism"],
    answer:"Checks and balances",
    hint:{why:"Each branch can limit (check) the others.", keyPoints:["Limits on branches","Prevent tyranny"]}
  },
  {
    cs:"CS6",
    prompt:"Which Enlightenment thinker’s ideas most influenced the Constitution’s separation of powers?",
    choices:["Baron de Montesquieu","John Locke","Thomas Hobbes","Voltaire"],
    answer:"Baron de Montesquieu",
    hint:{why:"Montesquieu argued for separating power to prevent tyranny.", keyPoints:["Montesquieu","Separation of powers"]}
  },
  {
    cs:"CS6",
    prompt:"Which statement best explains what the Supremacy Clause does?",
    choices:[
      "It establishes that federal law is the supreme law of the land",
      "It allows states to ignore federal laws",
      "It gives states power over treaties",
      "It makes local ordinances override the Constitution"
    ],
    answer:"It establishes that federal law is the supreme law of the land",
    hint:{why:"Supremacy = federal Constitution/laws/treaties outrank state law.", keyPoints:["Supremacy Clause","Federal law highest"]}
  },
  {
    cs:"CS6",
    prompt:"Which statement best explains how the Constitution connects government to the people?",
    choices:[
      "It ensures people have a role in electing representatives",
      "It bans voting to prevent conflict",
      "It gives all power to appointed officials",
      "It requires citizens to serve in office"
    ],
    answer:"It ensures people have a role in electing representatives",
    hint:{why:"Representation and elections connect people to government.", keyPoints:["Elections","Representation"]}
  },
  {
    cs:"CS6",
    prompt:"A student claims the Constitution is “flexible.” Which feature best supports that claim?",
    choices:["The ability to amend the Constitution","The absence of any written rules","Lifetime elections for Congress","Only one branch of government"],
    answer:"The ability to amend the Constitution",
    hint:{why:"Amendments allow change over time.", keyPoints:["Amendments","Adapt"]}
  },
  {
    cs:"CS6",
    prompt:"Which option best fits the Constitution’s goal of limiting government to protect individual and civil liberties?",
    choices:[
      "Setting boundaries so government power does not become unlimited",
      "Giving government unchecked surveillance powers",
      "Allowing leaders to ignore laws in emergencies",
      "Replacing courts with military tribunals"
    ],
    answer:"Setting boundaries so government power does not become unlimited",
    hint:{why:"Limited government protects liberties by restricting power.", keyPoints:["Limited government","Rights protection"]}
  },
  {
    cs:"CS6",
    prompt:"Which clause in Article IV helps states work together by recognizing public acts and legal decisions across state lines?",
    choices:["Full Faith and Credit Clause","Necessary and Proper Clause","Commerce Clause","Establishment Clause"],
    answer:"Full Faith and Credit Clause",
    hint:{why:"It supports national unity by requiring recognition of other states’ acts/records.", keyPoints:["Article IV","Full Faith and Credit"]}
  },
  {
    cs:"CS6",
    prompt:"Cause → Effect: If the national government can levy taxes under the Constitution, the most likely effect is that it can:",
    choices:[
      "Fund national programs and responsibilities",
      "Eliminate all state governments",
      "End the court system",
      "Ban elections in the states"
    ],
    answer:"Fund national programs and responsibilities",
    hint:{why:"Taxation provides revenue for national responsibilities.", keyPoints:["National taxation","Funding government"]}
  },
  {
    cs:"CS6",
    prompt:"Which example best shows “limited government” in practice?",
    choices:[
      "A government must follow the Constitution and laws",
      "A leader can punish critics without a trial",
      "A government can search anyone at any time",
      "A president can rewrite elections unilaterally"
    ],
    answer:"A government must follow the Constitution and laws",
    hint:{why:"Limited government = rule of law + restricted powers.", keyPoints:["Rule of law","Limits"]}
  },
  {
    cs:"CS6",
    prompt:"Which option best describes the relationship between federalism and rights protection?",
    choices:[
      "Power divided between national and state governments can limit overreach",
      "Federalism eliminates all conflicts over power",
      "Federalism means only states can protect rights",
      "Federalism means only the national government exists"
    ],
    answer:"Power divided between national and state governments can limit overreach",
    hint:{why:"Dividing power can prevent one level from becoming too dominant.", keyPoints:["Division of power","Prevent overreach"]}
  },
  {
    cs:"CS6",
    prompt:"Which statement is the best summary of CS6?",
    choices:[
      "The Constitution created a stronger structure and limited government to protect liberties",
      "The Constitution removed elections and centralized all power",
      "The Constitution ended federalism and eliminated states",
      "The Constitution made rights optional"
    ],
    answer:"The Constitution created a stronger structure and limited government to protect liberties",
    hint:{why:"CS6 emphasizes structure + limited government + liberties.", keyPoints:["Structure","Limited government","Liberties"]}
  },
  {
    cs:"CS6",
    prompt:"Which principle divides power among legislative, executive, and judicial branches to reduce the chance of tyranny?",
    choices:["Separation of powers","Popular sovereignty","Judicial review","Unicameralism"],
    answer:"Separation of powers",
    hint:{why:"Separating powers reduces concentration of authority.", keyPoints:["3 branches","Prevent tyranny"]}
  },

  // -------- CS7 (14) --------
  {
    cs:"CS7",
    prompt:"Which statement best explains what the Federalist Papers were designed to do?",
    choices:[
      "Convince people to support ratification of the U.S. Constitution",
      "End slavery immediately in all states",
      "Promote isolationism after World War I",
      "Create the first political party platform"
    ],
    answer:"Convince people to support ratification of the U.S. Constitution",
    hint:{why:"They were persuasive essays supporting ratification.", keyPoints:["Federalist Papers","Ratification"]}
  },
  {
    cs:"CS7",
    prompt:"Which statement reflects a key argument made by Federalists during ratification debates?",
    choices:[
      "A stronger national government is needed for stability and effective governance",
      "States should be independent countries",
      "The president should be a king",
      "Congress should have no power to tax"
    ],
    answer:"A stronger national government is needed for stability and effective governance",
    hint:{why:"Federalists argued the nation needed a stronger central authority.", keyPoints:["Strong national government","Stability"]}
  },
  {
    cs:"CS7",
    prompt:"Which position did Anti-Federalists take during ratification debates over the Constitution?",
    choices:[
      "A written bill of rights is necessary to protect individual liberty",
      "The Constitution should remove all state governments",
      "The Constitution should increase the power of the king",
      "The Bill of Rights is unnecessary because government will always be fair"
    ],
    answer:"A written bill of rights is necessary to protect individual liberty",
    hint:{why:"Anti-Federalists demanded written protections for individual rights.", keyPoints:["Bill of Rights","Liberty"]}
  },
  {
    cs:"CS7",
    prompt:"Which criticism did Anti-Federalists express about the Constitution during the ratification debates?",
    choices:[
      "It lacked explicit protections for individual rights",
      "It created too weak a national government",
      "It abolished Congress",
      "It required states to print their own money"
    ],
    answer:"It lacked explicit protections for individual rights",
    hint:{why:"This is the central Anti-Federalist critique tied to the Bill of Rights.", keyPoints:["No bill of rights","Rights protections"]}
  },
  {
    cs:"CS7",
    prompt:"Which concern best matches the Anti-Federalists about national taxation?",
    choices:[
      "Taxes could become oppressive and threaten liberty",
      "Taxes should never be collected by any government",
      "Only kings should set taxes",
      "Taxes should replace elections"
    ],
    answer:"Taxes could become oppressive and threaten liberty",
    hint:{why:"They feared national taxation could become repressive.", keyPoints:["Repressive taxation","Liberty"]}
  },
  {
    cs:"CS7",
    prompt:"Anti-Federalists feared a standing army could:",
    choices:[
      "Be used against citizens",
      "Make elections more frequent",
      "Increase individual rights automatically",
      "Replace state governments with courts"
    ],
    answer:"Be used against citizens",
    hint:{why:"A standing army was viewed as a tool of tyranny.", keyPoints:["Standing army","Tyranny risk"]}
  },
  {
    cs:"CS7",
    prompt:"Which statement best explains the compromise that helped secure ratification?",
    choices:[
      "Promise to add amendments protecting individual liberties (Bill of Rights)",
      "Promise to end Congress and create one leader",
      "Promise to eliminate courts",
      "Promise to ban all state governments"
    ],
    answer:"Promise to add amendments protecting individual liberties (Bill of Rights)",
    hint:{why:"Federalists promised to support a Bill of Rights after ratification.", keyPoints:["Compromise","Bill of Rights"]}
  },
  {
    cs:"CS7",
    prompt:"Which right is an example of civil liberties added through the Bill of Rights (as highlighted in the standards examples)?",
    choices:[
      "Protection against unreasonable search and seizure",
      "Right to receive government employment",
      "Right to free housing",
      "Right to unlimited executive power"
    ],
    answer:"Protection against unreasonable search and seizure",
    hint:{why:"Fourth Amendment protections are classic civil liberties limiting government power.", keyPoints:["4th Amendment","Limits on power"]}
  },
  {
    cs:"CS7",
    prompt:"Which set contains only First Amendment freedoms commonly emphasized in the Bill of Rights examples?",
    choices:[
      "Speech, press, assembly, petition, religion",
      "Voting at 18, direct election of senators, income tax",
      "Social Security, minimum wage, Medicare",
      "Annexation, neutrality, containment"
    ],
    answer:"Speech, press, assembly, petition, religion",
    hint:{why:"Those five freedoms are core 1st Amendment liberties.", keyPoints:["1st Amendment","Civil liberties"]}
  },
  {
    cs:"CS7",
    prompt:"Cause → Effect: Anti-Federalist criticism about individual rights most directly led to:",
    choices:[
      "The introduction and ratification of the Bill of Rights",
      "The creation of the Federal Reserve",
      "The Monroe Doctrine",
      "The repeal of the Constitution"
    ],
    answer:"The introduction and ratification of the Bill of Rights",
    hint:{why:"Anti-Federalist pressure pushed for a Bill of Rights.", keyPoints:["Debate outcome","Bill of Rights"]}
  },
  {
    cs:"CS7",
    prompt:"A student says, “Checks and balances were enough, so rights didn’t matter.” Which response best aligns with CS7?",
    choices:[
      "Anti-Federalists argued structure was not enough without written protections for individual liberties",
      "Both sides agreed rights were irrelevant",
      "The debate was mainly about industrialization",
      "The debate was mainly about World War I"
    ],
    answer:"Anti-Federalists argued structure was not enough without written protections for individual liberties",
    hint:{why:"CS7 highlights the demand for explicit rights protections.", keyPoints:["Written rights","Limits on power"]}
  },
  {
    cs:"CS7",
    prompt:"Which statement best explains why the Bill of Rights also connects to “limits on government power”?",
    choices:[
      "It restricts what government can do to individuals",
      "It guarantees government can act without limits",
      "It removes courts from reviewing government actions",
      "It ends all debate about rights"
    ],
    answer:"It restricts what government can do to individuals",
    hint:{why:"Civil liberties are limits on government actions.", keyPoints:["Limits on government","Civil liberties"]}
  },
  {
    cs:"CS7",
    prompt:"Which option best summarizes CS7?",
    choices:[
      "Debates over protections and limits produced the Bill of Rights",
      "The Constitution banned individual liberties",
      "The debate ended federalism",
      "The debate was only about foreign policy"
    ],
    answer:"Debates over protections and limits produced the Bill of Rights",
    hint:{why:"The key outcome is the Bill of Rights.", keyPoints:["Debates","Bill of Rights"]}
  },
  {
    cs:"CS7",
    prompt:"A historian argues: “Ratification debates were only about economics.” Which evidence best refutes that claim?",
    choices:[
      "A major debate focused on protecting individual liberties and limiting government power",
      "The debates only discussed assembly lines",
      "The debates only discussed immigration quotas",
      "The debates only discussed the Great Depression"
    ],
    answer:"A major debate focused on protecting individual liberties and limiting government power",
    hint:{why:"Rights protections were central, not just economics.", keyPoints:["Rights protections","Limits on power"]}
  }
];

/* =========
   ENGINE — FIRST-TRY ACCURACY STANDARD
   ========= */
const $ = (s)=>document.querySelector(s);
const screens = { start: $("#screenStart"), game: $("#screenGame"), done: $("#screenDone") };
const meta = { name: $("#mName"), start: $("#mStart"), time: $("#mTime"), acc: $("#mAcc") };
const qUI = {
  kicker: $("#qKicker"), text: $("#qText"), choices: $("#choices"),
  count: $("#qCount"), total: $("#qTotal"), bar: $("#barFill"),
  feedback: $("#feedback"),
  hintBox: $("#hintBox"), hintText: $("#hintText"), hintSmall: $("#hintSmall")
};

let state = {
  startedAt:null, timerId:null,
  idx:0,
  questionsCompleted:0,
  correctFirst:0,
  misses:0,
  missedThisQuestion:false,
  qOrder:[]
};

$("#btnDemo").addEventListener("click", ()=>{ $("#name").value="Demo Student"; $("#name").focus(); });
$("#btnStart").addEventListener("click", startGame);
$("#btnReset").addEventListener("click", resetAll);
$("#btnPlayAgain").addEventListener("click", resetAll);
$("#btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("#logOut").innerText);
    $("#btnCopy").textContent="Copied ✅";
    setTimeout(()=>$("#btnCopy").textContent="Copy Ticket", 1100);
  }catch(e){
    alert("Copy failed. You can manually select and copy the ticket text.");
  }
});

function calcAccuracy(){
  if(state.questionsCompleted <= 0) return 100;
  return Math.round((state.correctFirst / state.questionsCompleted) * 100);
}
function updateAccuracy(){ meta.acc.textContent = `${calcAccuracy()}%`; }

function shuffledChoices(q){
  const arr = [...q.choices];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function startGame(){
  const n = ($("#name").value||"").trim();
  if(!n){ alert("Please enter your name."); return; }

  state.startedAt = new Date();
  meta.name.textContent = n;
  meta.start.textContent = stamp(state.startedAt);
  meta.time.textContent = "00:00";

  state.qOrder = shuffle([...QUESTIONS]);
  state.idx = 0;
  state.questionsCompleted = 0;
  state.correctFirst = 0;
  state.misses = 0;
  state.missedThisQuestion = false;

  $("#qTotal").textContent = String(state.qOrder.length);
  updateAccuracy();

  switchTo("game");
  startTimer();
  renderQuestion();
}

function renderQuestion(){
  const q = state.qOrder[state.idx];
  if(!q) return finish();

  state.missedThisQuestion = false;

  qUI.kicker.textContent = `${q.cs} • Question ${state.idx+1}`;
  qUI.text.textContent = q.prompt;

  qUI.count.textContent = String(state.idx+1);
  qUI.total.textContent = String(state.qOrder.length);
  qUI.bar.style.width = `${Math.round((state.idx/state.qOrder.length)*100)}%`;

  qUI.feedback.textContent = "Choose the best answer.";
  qUI.feedback.style.color = "var(--muted)";

  qUI.hintBox.style.display = "none";
  qUI.hintText.textContent = "";
  qUI.hintSmall.textContent = "";

  drawChoices(q);
}

function drawChoices(q){
  qUI.choices.innerHTML = "";
  shuffledChoices(q).forEach(choice=>{
    const btn = document.createElement("button");
    btn.textContent = choice;
    btn.addEventListener("click", ()=>submit(choice));
    qUI.choices.appendChild(btn);
  });
}

function submit(choice){
  const q = state.qOrder[state.idx];

  if(choice === q.answer){
    state.questionsCompleted++;
    if(!state.missedThisQuestion) state.correctFirst++;
    updateAccuracy();

    qUI.feedback.textContent = "Correct ✅";
    qUI.feedback.style.color = "var(--good)";
    flashButtons(choice, true);

    setTimeout(()=>{ state.idx++; renderQuestion(); }, 320);
    return;
  }

  if(!state.missedThisQuestion){
    state.misses++;
    state.missedThisQuestion = true;
    updateAccuracy();
  }

  qUI.feedback.textContent = "Not yet ❌ Try again.";
  qUI.feedback.style.color = "var(--bad)";
  flashButtons(choice, false);

  qUI.hintBox.style.display = "block";
  qUI.hintText.textContent = q.hint?.why || "Think back to the standard’s wording and examples.";
  qUI.hintSmall.textContent = q.hint?.keyPoints?.length ? ("Key points: " + q.hint.keyPoints.join(" • ")) : "";

  drawChoices(q); // reshuffle after a miss
}

function finish(){
  stopTimer();
  qUI.bar.style.width = "100%";

  const endedAt = new Date();
  const durationSec = Math.floor((endedAt - state.startedAt)/1000);
  const accuracy = calcAccuracy();

  if(state.misses > 0){
    $("#doneTitle").textContent = "Not Passed ❌";
    $("#doneMsg").textContent = "You finished, but this attempt had missed questions. Retake for a perfect run to earn the submit ticket.";
    $("#btnCopy").style.display = "none";

    $("#logOut").textContent =
`NOT PASSED — Retake Required

Student: ${meta.name.textContent}
Started: ${stamp(state.startedAt)}
Ended:   ${stamp(endedAt)}
Duration (sec): ${durationSec}
First-try Accuracy: ${accuracy}%
Missed Questions: ${state.misses}

RULE: To earn a submit ticket, you must complete the game with 0 missed questions (100% first-try accuracy).`;
    switchTo("done");
    return;
  }

  $("#doneTitle").textContent = "Complete ✅";
  $("#doneMsg").textContent = "Perfect run achieved (0 missed questions). Copy your submit ticket.";
  $("#btnCopy").style.display = "inline-flex";

  const ticket = {
    status: "PASSED",
    game: "American History — Block 12 (CS 6–7)",
    student: meta.name.textContent,
    started: stamp(state.startedAt),
    ended: stamp(endedAt),
    duration_seconds: durationSec,
    total_questions: state.qOrder.length,
    questions_completed: state.questionsCompleted,
    missed_questions: state.misses,
    first_try_accuracy_percent: 100
  };

  $("#logOut").textContent = JSON.stringify(ticket, null, 2);
  switchTo("done");
}

function switchTo(which){
  Object.values(screens).forEach(el=>el.classList.add("hidden"));
  screens[which].classList.remove("hidden");
}

function startTimer(){
  stopTimer();
  state.timerId = setInterval(()=>{
    const s = Math.floor((new Date() - state.startedAt)/1000);
    meta.time.textContent = fmtTime(s);
  }, 250);
}
function stopTimer(){ if(state.timerId){ clearInterval(state.timerId); state.timerId=null; } }

function resetAll(){
  stopTimer();
  meta.name.textContent="—";
  meta.start.textContent="—";
  meta.time.textContent="00:00";
  meta.acc.textContent="100%";
  $("#name").value="";
  $("#btnCopy").textContent="Copy Ticket";
  $("#btnCopy").style.display = "inline-flex";
  switchTo("start");
}

function fmtTime(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stamp(d){
  return d.toLocaleString(undefined, {
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function flashButtons(choice, correct){
  [...qUI.choices.querySelectorAll("button")].forEach(b=>{
    if(b.textContent === choice){
      b.classList.add(correct ? "good" : "bad");
      setTimeout(()=>b.classList.remove("good","bad"), 320);
    }
  });
}
</script>
</body>
</html>
