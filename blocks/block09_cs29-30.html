<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>American History — Block 9 (CS 29–30) Game</title>
<style>
  :root{
    --bg:#0b1220; --card:#111a2e; --ink:#e7eefc; --muted:#a8b4cf;
    --accent:#7aa2ff; --good:#2bd576; --bad:#ff5c7a; --warn:#ffd166;
    --border:rgba(255,255,255,.12); --shadow:0 18px 55px rgba(0,0,0,.35);
    --r:18px;
  }
  *{box-sizing:border-box}
  body{
    margin:0; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;
    background:radial-gradient(1000px 650px at 18% 12%, rgba(122,162,255,.18), transparent 60%), var(--bg);
    color:var(--ink); min-height:100vh;
    display:flex; align-items:center; justify-content:center; padding:18px;
  }
  .app{width:min(980px,100%); background:rgba(17,26,46,.9); border:1px solid var(--border);
    border-radius:var(--r); box-shadow:var(--shadow); overflow:hidden}
  header{padding:16px 18px; display:flex; gap:12px; align-items:flex-start; justify-content:space-between;
    border-bottom:1px solid var(--border);
    background:linear-gradient(180deg, rgba(255,255,255,.06), transparent)}
  .title{display:flex; flex-direction:column; gap:4px}
  .title h1{margin:0; font-size:16px; letter-spacing:.2px}
  .title .sub{color:var(--muted); font-size:12px; line-height:1.3}
  .meta{display:flex; gap:10px; flex-wrap:wrap; justify-content:flex-end; align-items:center}
  .pill{border:1px solid var(--border); border-radius:999px; padding:6px 10px; font-size:12px; color:var(--muted); background:rgba(0,0,0,.18)}
  .pill b{color:var(--ink); font-weight:700}
  main{padding:18px; display:grid; gap:14px}
  .card{background:rgba(0,0,0,.22); border:1px solid var(--border); border-radius:var(--r); padding:16px}
  .row{display:flex; gap:12px; flex-wrap:wrap; align-items:center; justify-content:space-between}
  label{font-size:12px; color:var(--muted)}
  input[type="text"]{
    width:min(420px,100%); padding:10px 12px; border-radius:12px;
    border:1px solid var(--border); background:rgba(0,0,0,.25); color:var(--ink);
    outline:none;
  }
  button{
    cursor:pointer; border:none; border-radius:14px; padding:12px 12px;
    font-weight:800; color:var(--ink); background:rgba(122,162,255,.18);
    border:1px solid rgba(122,162,255,.35);
    transition:transform .08s ease, filter .12s ease;
  }
  button:hover{filter:brightness(1.06)}
  button:active{transform:scale(.99)}
  button.secondary{background:rgba(255,255,255,.06); border:1px solid var(--border); color:var(--muted)}
  button.good{background:rgba(43,213,118,.14); border:1px solid rgba(43,213,118,.35)}
  button.bad{background:rgba(255,92,122,.14); border:1px solid rgba(255,92,122,.35)}
  .qTop{display:flex; align-items:flex-start; justify-content:space-between; gap:10px}
  .kicker{color:var(--muted); font-size:12px}
  .qTitle{margin:0; font-size:14px; line-height:1.35}
  .status{display:flex; gap:10px; flex-wrap:wrap; align-items:center}
  .bar{height:10px; background:rgba(255,255,255,.08); border-radius:999px; overflow:hidden; border:1px solid var(--border); width:220px}
  .bar>div{height:100%; width:0%; background:rgba(43,213,118,.75)}
  .grid{
    display:grid; gap:10px; margin-top:10px;
    grid-template-columns:repeat(2, minmax(0,1fr));
  }
  @media (max-width:640px){ .grid{grid-template-columns:1fr} }
  .hint{
    margin-top:10px; padding:10px 12px; border-radius:14px;
    background:rgba(255,209,102,.10); border:1px solid rgba(255,209,102,.35);
    display:none;
  }
  .hint .small{color:var(--muted); font-size:12px; margin-top:4px; line-height:1.35}
  .toast{font-size:12px; color:var(--muted)}
  .hidden{display:none !important}
  pre{
    white-space:pre-wrap; word-break:break-word;
    background:rgba(0,0,0,.25); border:1px solid var(--border); padding:12px; border-radius:14px;
    color:var(--ink); font-size:12px; line-height:1.35; margin:10px 0 0;
  }
</style>
</head>
<body>
<div class="app" role="application" aria-label="American History Block 9 Game">
  <header>
    <div class="title">
      <h1>American History — Block 9 Game (CS 29–30)</h1>
      <div class="sub">Science/technology + postwar boom • Suburbs, Sun Belt, immigration (1965) • Perfect run required for submit ticket</div>
    </div>
    <div class="meta">
      <div class="pill">Name: <b id="mName">—</b></div>
      <div class="pill">Started: <b id="mStart">—</b></div>
      <div class="pill">Time: <b id="mTime">00:00</b></div>
      <div class="pill">Accuracy: <b id="mAcc">100%</b></div>
    </div>
  </header>

  <main>
    <section id="screenStart" class="card">
      <div class="row">
        <div>
          <div class="kicker">Enter your name to begin</div>
          <div style="margin-top:8px">
            <label for="name">Student Name</label><br/>
            <input id="name" type="text" autocomplete="name" placeholder="Type your name…" />
          </div>
        </div>
        <div style="display:flex; gap:10px; align-items:center">
          <button id="btnStart">Start</button>
          <button id="btnDemo" class="secondary">Demo</button>
        </div>
      </div>
      <div class="toast" style="margin-top:10px">
        Rules: hints only after a miss • <b>miss counts once per question</b> • choices reshuffle after miss • must finish with 0 misses to earn ticket.
      </div>
    </section>

    <section id="screenGame" class="card hidden">
      <div class="qTop">
        <div>
          <div class="kicker" id="qKicker">Question</div>
          <p class="qTitle" id="qText">—</p>
        </div>
        <div class="status">
          <div class="bar"><div id="barFill"></div></div>
          <div class="toast"><span id="qCount">0</span>/<span id="qTotal">0</span></div>
        </div>
      </div>

      <div class="grid" id="choices"></div>

      <div class="hint" id="hintBox" role="note" aria-label="Hint">
        <div><b>Hint (only after a miss):</b></div>
        <div id="hintText" style="margin-top:6px"></div>
        <div class="small" id="hintSmall"></div>
      </div>

      <div class="row" style="margin-top:14px">
        <div class="toast" id="feedback">—</div>
        <div style="display:flex; gap:10px">
          <button id="btnReset" class="secondary">Reset</button>
        </div>
      </div>
    </section>

    <section id="screenDone" class="card hidden">
      <div class="row">
        <div>
          <h2 id="doneTitle" style="margin:0 0 6px; font-size:16px;">Complete ✅</h2>
          <div class="toast" id="doneMsg">Perfect run achieved. Copy your submit ticket.</div>
        </div>
        <div style="display:flex; gap:10px">
          <button id="btnCopy" class="good">Copy Ticket</button>
          <button id="btnPlayAgain" class="secondary">Play Again</button>
        </div>
      </div>
      <pre id="logOut"></pre>
    </section>
  </main>
</div>

<script>
/* =========================================================
   QUESTIONS — Block 9 (CS 29–30) — 30 items (>=25 rule met)
   CS29: Postwar boom + advances in science/tech → changes in life
   CS30: Suburbs + Rust Belt→Sun Belt + Immigration Act of 1965 → effects
   ========================================================= */
const QUESTIONS = shuffle([
  /* ---------- CS29 (15) ---------- */
  {
    cs:"CS29",
    prompt:"Which statement best explains how advances in science and technology affected American life after WWII?",
    choices:[
      "They increased productivity and changed how Americans worked, traveled, and communicated",
      "They ended consumer demand for new goods",
      "They stopped medical research and innovation",
      "They eliminated mass media"
    ],
    answer:"They increased productivity and changed how Americans worked, traveled, and communicated",
    hint:{ why:"CS29 centers on how science/tech reshaped work, home life, and communication.", keyPoints:["Productivity","Daily life changes"] }
  },
  {
    cs:"CS29",
    prompt:"Which postwar development best shows how medicine improved quality of life?",
    choices:["Vaccines/antibiotics reducing deadly diseases","A return to pre-industrial farming","Banning hospitals nationwide","Ending public health programs"],
    answer:"Vaccines/antibiotics reducing deadly diseases",
    hint:{ why:"Medical advances helped people live longer and reduced certain diseases.", keyPoints:["Public health","Longer life expectancy"] }
  },
  {
    cs:"CS29",
    prompt:"Which invention most directly helped households save time on daily chores in the postwar era?",
    choices:["Widespread use of home appliances (washers, dryers, etc.)","The telegraph","The cotton gin","The plow"],
    answer:"Widespread use of home appliances (washers, dryers, etc.)",
    hint:{ why:"Consumer appliances expanded during the boom and reshaped home life.", keyPoints:["Appliances","Standard of living"] }
  },
  {
    cs:"CS29",
    prompt:"Which statement best connects the Space Race to science and technology advances in the U.S.?",
    choices:["Competition with the USSR encouraged investment in research and STEM education","The Space Race ended all scientific study","Space exploration reduced technology development","Competition decreased interest in engineering"],
    answer:"Competition with the USSR encouraged investment in research and STEM education",
    hint:{ why:"Cold War competition drove federal support for science and education.", keyPoints:["Research funding","STEM education"] }
  },
  {
    cs:"CS29",
    prompt:"Which change best reflects a shift from an industrial economy to a service/technology economy?",
    choices:["More jobs in offices, education, health care, and technology sectors","Most jobs returning to small farms","A complete end to manufacturing","Eliminating trade and business"],
    answer:"More jobs in offices, education, health care, and technology sectors",
    hint:{ why:"Postwar America saw growth in service and tech work.", keyPoints:["Service economy","Technology sector"] }
  },
  {
    cs:"CS29",
    prompt:"Which factor best explains why productivity increased in many industries after WWII?",
    choices:["New technologies and automation improved efficiency","Factories stopped using machines","Workers abandoned training and education","Companies ended research spending"],
    answer:"New technologies and automation improved efficiency",
    hint:{ why:"Automation and improved processes increased output per worker.", keyPoints:["Automation","Efficiency"] }
  },
  {
    cs:"CS29",
    prompt:"Which statement best describes how mass media affected American culture after WWII?",
    choices:["TV and advertising promoted shared popular culture and consumer trends","Media ended national communication","Newspapers disappeared completely","Americans stopped following national events"],
    answer:"TV and advertising promoted shared popular culture and consumer trends",
    hint:{ why:"Mass media spread common entertainment, news, and advertising.", keyPoints:["Shared culture","Advertising"] }
  },
  {
    cs:"CS29",
    prompt:"Cause → effect: Increased research and development spending after WWII most directly led to:",
    choices:["new products and innovations that reshaped daily life","a decline in all new inventions","the end of consumer electronics","the end of modern medicine"],
    answer:"new products and innovations that reshaped daily life",
    hint:{ why:"Investment in research produced new technologies and consumer goods.", keyPoints:["R&D","Innovation"] }
  },
  {
    cs:"CS29",
    prompt:"Which example best shows how communication technology changed life in the late 20th century?",
    choices:["Computers and improved telecommunications sped up communication and work","Communication relied only on handwritten letters","The U.S. banned telephones","Mass media ended after WWII"],
    answer:"Computers and improved telecommunications sped up communication and work",
    hint:{ why:"Computers/telecom changed work, information access, and communication speed.", keyPoints:["Computers","Telecommunications"] }
  },
  {
    cs:"CS29",
    prompt:"A historian claims: “Postwar science helped create a modern consumer lifestyle.” Which evidence best supports that claim?",
    choices:["New technologies produced TVs, appliances, and improved cars used widely by families","Americans stopped buying household goods","People abandoned modern housing","Consumer choice narrowed to one product"],
    answer:"New technologies produced TVs, appliances, and improved cars used widely by families",
    hint:{ why:"Tech innovation fueled consumer goods and new lifestyles.", keyPoints:["Consumer goods","Technology"] }
  },
  {
    cs:"CS29",
    prompt:"Which development best connects science to national defense during the Cold War?",
    choices:["Government investment in research for aerospace and advanced weapons systems","Abolishing the military","Ending scientific education","Banning engineers from government jobs"],
    answer:"Government investment in research for aerospace and advanced weapons systems",
    hint:{ why:"Cold War defense priorities boosted scientific investment.", keyPoints:["Defense R&D","Cold War"] }
  },
  {
    cs:"CS29",
    prompt:"Which statement best explains a common social effect of new technologies in the workplace?",
    choices:["Some jobs changed or required new skills as machines and computers increased efficiency","All workers returned to farm labor","Technology eliminated the need for education","No job changed after WWII"],
    answer:"Some jobs changed or required new skills as machines and computers increased efficiency",
    hint:{ why:"Technology often shifts skill needs and job roles.", keyPoints:["Skill shift","Workplace change"] }
  },
  {
    cs:"CS29",
    prompt:"Which best illustrates how science/technology affected transportation in the postwar era?",
    choices:["Improved automobiles and air travel expanded mobility and travel options","Americans stopped traveling entirely","All highways were removed","Airplanes were banned from civilian use"],
    answer:"Improved automobiles and air travel expanded mobility and travel options",
    hint:{ why:"Transportation innovations increased mobility and reshaped regions.", keyPoints:["Autos","Air travel"] }
  },
  {
    cs:"CS29",
    prompt:"Which cause-and-effect best matches the idea of “epic changes in American life” after WWII?",
    choices:["Tech advances + economic growth → changes in home life, work, and entertainment","Tech advances → fewer products and lower living standards","Economic boom → end of mass media","Science advances → less communication"],
    answer:"Tech advances + economic growth → changes in home life, work, and entertainment",
    hint:{ why:"CS29 emphasizes broad lifestyle change linked to tech and prosperity.", keyPoints:["Home","Work","Entertainment"] }
  },
  {
    cs:"CS29",
    prompt:"Which statement BEST summarizes CS29?",
    choices:["Scientific and technological advances during the postwar boom transformed daily life and the economy","The postwar boom ended innovation and reduced living standards","The U.S. returned to an agrarian economy after WWII","Technology had no effect on American culture"],
    answer:"Scientific and technological advances during the postwar boom transformed daily life and the economy",
    hint:{ why:"That’s the heart of CS29: boom + science/tech → major change.", keyPoints:["Boom","Science/tech","Change"] }
  },

  /* ---------- CS30 (15) ---------- */
  {
    cs:"CS30",
    prompt:"Which trend best describes population movement after WWII?",
    choices:["Population flow from cities to growing suburbs","A mass return to frontier homesteading","A complete end to movement inside the U.S.","Most Americans migrating to Europe"],
    answer:"Population flow from cities to growing suburbs",
    hint:{ why:"Suburbanization grew rapidly after WWII.", keyPoints:["Suburbanization","City-to-suburb"] }
  },
  {
    cs:"CS30",
    prompt:"Which factor most helped make suburban growth possible for many families?",
    choices:["Highway expansion and affordable home financing","A ban on car ownership","An end to all home construction","The disappearance of commuting jobs"],
    answer:"Highway expansion and affordable home financing",
    hint:{ why:"Transportation + housing access supported suburban growth.", keyPoints:["Highways","Housing access"] }
  },
  {
    cs:"CS30",
    prompt:"Which statement best explains a social/political effect of suburbanization in many areas?",
    choices:["Changes in school districts, tax bases, and representation as populations moved","End of all elections","No changes in local government services","Elimination of public schools"],
    answer:"Changes in school districts, tax bases, and representation as populations moved",
    hint:{ why:"Where people live affects taxes, schools, and political power.", keyPoints:["Tax base","Schools","Representation"] }
  },
  {
    cs:"CS30",
    prompt:"The term “Rust Belt” most directly refers to:",
    choices:["Older industrial regions that lost manufacturing jobs","New desert suburbs in the Southwest","Coastal fishing villages","The Appalachian frontier in 1800"],
    answer:"Older industrial regions that lost manufacturing jobs",
    hint:{ why:"Rust Belt = deindustrializing areas, often in the Midwest/Northeast.", keyPoints:["Deindustrialization","Job loss"] }
  },
  {
    cs:"CS30",
    prompt:"Which best explains why some Americans migrated from the Rust Belt to the Sun Belt?",
    choices:["Job opportunities and growth industries expanded in the South and West","The Sun Belt banned new residents","Factories grew fastest in the Rust Belt","The government forced people to relocate"],
    answer:"Job opportunities and growth industries expanded in the South and West",
    hint:{ why:"Economic opportunity pulled workers toward faster-growing regions.", keyPoints:["Jobs","Growth regions"] }
  },
  {
    cs:"CS30",
    prompt:"Which is a political effect of large population growth in the Sun Belt states?",
    choices:["Increased representation and electoral influence for growing states","Automatic loss of congressional seats for Sun Belt states","End of presidential elections","Sun Belt states leaving the U.S."],
    answer:"Increased representation and electoral influence for growing states",
    hint:{ why:"Population shifts can change congressional apportionment and electoral votes.", keyPoints:["Representation","Electoral votes"] }
  },
  {
    cs:"CS30",
    prompt:"Which law is most directly linked to increased immigration from Asia, Africa, and Latin America?",
    choices:["Immigration and Nationality Act of 1965","Alien and Sedition Acts","Kansas-Nebraska Act","Homestead Act"],
    answer:"Immigration and Nationality Act of 1965",
    hint:{ why:"The 1965 law changed immigration patterns and increased immigration from many regions.", keyPoints:["1965 Act","New patterns"] }
  },
  {
    cs:"CS30",
    prompt:"A major effect of the 1965 Immigration Act was:",
    choices:["Greater cultural and demographic diversity in many U.S. communities","A permanent end to immigration","Only European immigration allowed","Immediate elimination of all immigration debates"],
    answer:"Greater cultural and demographic diversity in many U.S. communities",
    hint:{ why:"Immigration increased and diversified, affecting society and politics.", keyPoints:["Diversity","Demographics"] }
  },
  {
    cs:"CS30",
    prompt:"Which scenario best shows a social effect of increased immigration after 1965?",
    choices:["Growth of new cultural communities and languages in cities and suburbs","The end of cultural diversity","Closure of all urban neighborhoods","No changes in any communities"],
    answer:"Growth of new cultural communities and languages in cities and suburbs",
    hint:{ why:"New immigrants often form communities and influence culture, schools, and politics.", keyPoints:["Communities","Culture","Schools"] }
  },
  {
    cs:"CS30",
    prompt:"Cause → effect: As people moved to suburbs, many cities experienced:",
    choices:["Declining tax bases and new challenges for services and schools","A sudden increase in factory jobs downtown","No change in city budgets","End of all public transportation"],
    answer:"Declining tax bases and new challenges for services and schools",
    hint:{ why:"Outmigration can reduce revenue and strain remaining services.", keyPoints:["Tax base decline","City services"] }
  },
  {
    cs:"CS30",
    prompt:"Which factor most contributed to Sun Belt growth in the late 20th century?",
    choices:["Air conditioning and expanding industries/defense/aerospace","A collapse of all southern jobs","A ban on new housing","The end of air travel"],
    answer:"Air conditioning and expanding industries/defense/aerospace",
    hint:{ why:"Climate comfort + jobs helped fuel growth in the South/West.", keyPoints:["Air conditioning","Industry growth"] }
  },
  {
    cs:"CS30",
    prompt:"Which is the best example of how migration can change politics?",
    choices:["States gaining population gain more congressional seats and influence","All states keep the same representation forever","Migration ends elections","Population changes never affect representation"],
    answer:"States gaining population gain more congressional seats and influence",
    hint:{ why:"Representation and electoral votes shift with population.", keyPoints:["Apportionment","Influence"] }
  },
  {
    cs:"CS30",
    prompt:"Which claim is most supported by the pattern of postwar migration and immigration?",
    choices:["Demographic change can reshape schools, labor markets, and voting patterns","Population change has no impact on society","Immigration only affected the 1800s","Suburbanization ended cultural change"],
    answer:"Demographic change can reshape schools, labor markets, and voting patterns",
    hint:{ why:"CS30 emphasizes social and political effects of movement and immigration.", keyPoints:["Schools","Labor","Voting"] }
  },
  {
    cs:"CS30",
    prompt:"A student argues: “The 1965 Immigration Act had only economic effects.” Which correction is strongest?",
    choices:["It also had social and political effects, including demographic change and new community influence","It had no effect on the U.S.","It ended immigration completely","It only affected agriculture in 1900"],
    answer:"It also had social and political effects, including demographic change and new community influence",
    hint:{ why:"CS30 includes social/political impacts, not only jobs and wages.", keyPoints:["Social effects","Political effects"] }
  },
  {
    cs:"CS30",
    prompt:"Which statement BEST summarizes CS30?",
    choices:["Suburbanization, Rust Belt→Sun Belt migration, and post-1965 immigration reshaped U.S. society and politics","Postwar America had no internal migration","Immigration decreased sharply after 1965","Cities grew while suburbs disappeared"],
    answer:"Suburbanization, Rust Belt→Sun Belt migration, and post-1965 immigration reshaped U.S. society and politics",
    hint:{ why:"That’s the core of CS30: movement + immigration → social/political change.", keyPoints:["Suburbs","Sun Belt","Immigration","Effects"] }
  }
]);

/* =========
   ENGINE — FIRST-TRY ACCURACY STANDARD (Block 7 style)
   ========= */
const $ = (s)=>document.querySelector(s);
const screens = { start: $("#screenStart"), game: $("#screenGame"), done: $("#screenDone") };
const meta = { name: $("#mName"), start: $("#mStart"), time: $("#mTime"), acc: $("#mAcc") };
const qUI = {
  kicker: $("#qKicker"), text: $("#qText"), choices: $("#choices"),
  count: $("#qCount"), total: $("#qTotal"), bar: $("#barFill"),
  feedback: $("#feedback"),
  hintBox: $("#hintBox"), hintText: $("#hintText"), hintSmall: $("#hintSmall")
};

let state = {
  startedAt:null, timerId:null,
  idx:0,
  // first-try accuracy tracking:
  questionsCompleted:0,
  correctFirst:0,
  misses:0,                 // counts ONCE per question (first wrong attempt)
  missedThisQuestion:false, // resets each new question
  qOrder:[]
};

$("#btnDemo").addEventListener("click", ()=>{ $("#name").value="Demo Student"; $("#name").focus(); });
$("#btnStart").addEventListener("click", startGame);
$("#btnReset").addEventListener("click", resetAll);
$("#btnPlayAgain").addEventListener("click", resetAll);
$("#btnCopy").addEventListener("click", async ()=>{
  try{
    await navigator.clipboard.writeText($("#logOut").innerText);
    $("#btnCopy").textContent="Copied ✅";
    setTimeout(()=>$("#btnCopy").textContent="Copy Ticket", 1100);
  }catch(e){
    alert("Copy failed. You can manually select and copy the ticket text.");
  }
});

function calcAccuracy(){
  if(state.questionsCompleted <= 0) return 100;
  return Math.round((state.correctFirst / state.questionsCompleted) * 100);
}
function updateAccuracy(){
  meta.acc.textContent = `${calcAccuracy()}%`;
}

/* Shuffle answer choices each render */
function shuffledChoices(q){
  const arr = [...q.choices];
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]] = [arr[j],arr[i]];
  }
  return arr;
}

function startGame(){
  const n = ($("#name").value||"").trim();
  if(!n){ alert("Please enter your name."); return; }

  state.startedAt = new Date();
  meta.name.textContent = n;
  meta.start.textContent = stamp(state.startedAt);
  meta.time.textContent = "00:00";

  state.qOrder = shuffle([...QUESTIONS]);
  state.idx = 0;
  state.questionsCompleted = 0;
  state.correctFirst = 0;
  state.misses = 0;
  state.missedThisQuestion = false;

  $("#qTotal").textContent = String(state.qOrder.length);
  updateAccuracy();

  switchTo("game");
  startTimer();
  renderQuestion();
}

function renderQuestion(){
  const q = state.qOrder[state.idx];
  if(!q) return finish();

  // reset per-question miss flag
  state.missedThisQuestion = false;

  qUI.kicker.textContent = `${q.cs} • Question ${state.idx+1}`;
  qUI.text.textContent = q.prompt;

  qUI.count.textContent = String(state.idx+1);
  qUI.total.textContent = String(state.qOrder.length);
  qUI.bar.style.width = `${Math.round((state.idx/state.qOrder.length)*100)}%`;

  qUI.feedback.textContent = "Choose the best answer.";
  qUI.feedback.style.color = "var(--muted)";

  qUI.hintBox.style.display = "none";
  qUI.hintText.textContent = "";
  qUI.hintSmall.textContent = "";

  drawChoices(q);
}

function drawChoices(q){
  qUI.choices.innerHTML = "";
  shuffledChoices(q).forEach(choice=>{
    const btn = document.createElement("button");
    btn.textContent = choice;
    btn.addEventListener("click", ()=>submit(choice));
    qUI.choices.appendChild(btn);
  });
}

function submit(choice){
  const q = state.qOrder[state.idx];

  if(choice === q.answer){
    // first-try credit if they never missed this question
    state.questionsCompleted++;
    if(!state.missedThisQuestion) state.correctFirst++;

    updateAccuracy();

    qUI.feedback.textContent = "Correct ✅";
    qUI.feedback.style.color = "var(--good)";
    flashButtons(choice, true);

    setTimeout(()=>{
      state.idx++;
      renderQuestion();
    }, 320);
    return;
  }

  // incorrect
  if(!state.missedThisQuestion){
    state.misses++;               // counts ONCE per question
    state.missedThisQuestion = true;
    updateAccuracy();
  }

  qUI.feedback.textContent = "Not yet ❌ Try again.";
  qUI.feedback.style.color = "var(--bad)";
  flashButtons(choice, false);

  qUI.hintBox.style.display = "block";
  qUI.hintText.textContent = q.hint?.why || "Think back to the content elaboration details.";
  qUI.hintSmall.textContent = q.hint?.keyPoints?.length
    ? ("Key points: " + q.hint.keyPoints.join(" • "))
    : "";

  // ✅ reshuffle choices after a miss (and after any wrong click)
  drawChoices(q);
}

function finish(){
  stopTimer();
  qUI.bar.style.width = "100%";

  const endedAt = new Date();
  const durationSec = Math.floor((endedAt - state.startedAt)/1000);
  const accuracy = calcAccuracy();

  if(state.misses > 0){
    $("#doneTitle").textContent = "Not Passed ❌";
    $("#doneMsg").textContent = "You finished, but this attempt had misses. Retake for a perfect run to earn the submit ticket.";
    $("#btnCopy").style.display = "none";

    $("#logOut").textContent =
`NOT PASSED — Retake Required

Student: ${meta.name.textContent}
Started: ${stamp(state.startedAt)}
Ended:   ${stamp(endedAt)}
Duration (sec): ${durationSec}
First-try Accuracy: ${accuracy}%
Missed Questions: ${state.misses}

RULE: To earn a submit ticket, you must complete the game with 0 missed questions (100% first-try accuracy).`;
    switchTo("done");
    return;
  }

  $("#doneTitle").textContent = "Complete ✅";
  $("#doneMsg").textContent = "Perfect run achieved (0 missed questions). Copy your submit ticket.";
  $("#btnCopy").style.display = "inline-flex";

  const ticket = {
    status: "PASSED",
    game: "American History — Block 9 (CS 29–30)",
    student: meta.name.textContent,
    started: stamp(state.startedAt),
    ended: stamp(endedAt),
    duration_seconds: durationSec,
    total_questions: state.qOrder.length,
    questions_completed: state.questionsCompleted,
    missed_questions: state.misses,
    first_try_accuracy_percent: 100
  };

  $("#logOut").textContent = JSON.stringify(ticket, null, 2);
  switchTo("done");
}

function switchTo(which){
  Object.values(screens).forEach(el=>el.classList.add("hidden"));
  screens[which].classList.remove("hidden");
}

function startTimer(){
  stopTimer();
  state.timerId = setInterval(()=>{
    const s = Math.floor((new Date() - state.startedAt)/1000);
    meta.time.textContent = fmtTime(s);
  }, 250);
}
function stopTimer(){
  if(state.timerId){ clearInterval(state.timerId); state.timerId=null; }
}

function resetAll(){
  stopTimer();
  meta.name.textContent="—";
  meta.start.textContent="—";
  meta.time.textContent="00:00";
  meta.acc.textContent="100%";
  $("#name").value="";
  $("#btnCopy").textContent="Copy Ticket";
  $("#btnCopy").style.display = "inline-flex";
  switchTo("start");
}

function fmtTime(sec){
  const m = String(Math.floor(sec/60)).padStart(2,"0");
  const s = String(sec%60).padStart(2,"0");
  return `${m}:${s}`;
}
function stamp(d){
  return d.toLocaleString(undefined, {
    year:"numeric", month:"2-digit", day:"2-digit",
    hour:"2-digit", minute:"2-digit", second:"2-digit"
  });
}
function shuffle(arr){
  for(let i=arr.length-1;i>0;i--){
    const j = Math.floor(Math.random()*(i+1));
    [arr[i],arr[j]]=[arr[j],arr[i]];
  }
  return arr;
}
function flashButtons(choice, correct){
  [...qUI.choices.querySelectorAll("button")].forEach(b=>{
    if(b.textContent === choice){
      b.classList.add(correct ? "good" : "bad");
      setTimeout(()=>b.classList.remove("good","bad"), 320);
    }
  });
}
</script>
</body>
</html>
